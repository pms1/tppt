<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SearchFilterParser.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">p2-tooling</a> &gt; <a href="../index.html" class="el_bundle">minimal-ldap-parser</a> &gt; <a href="index.source.html" class="el_package">com.github.pms1.ldap</a> &gt; <span class="el_source">SearchFilterParser.java</span></div><h1>SearchFilterParser.java</h1><pre class="source lang-java linenums">package com.github.pms1.ldap;

import java.util.List;
import java.util.stream.Collectors;

import org.antlr.v4.runtime.ANTLRInputStream;
import org.antlr.v4.runtime.BaseErrorListener;
import org.antlr.v4.runtime.CommonTokenStream;
import org.antlr.v4.runtime.Lexer;
import org.antlr.v4.runtime.RecognitionException;
import org.antlr.v4.runtime.Recognizer;

import com.github.pms1.ldap.Rfc4515Parser.AndContext;
import com.github.pms1.ldap.Rfc4515Parser.AttrContext;
import com.github.pms1.ldap.Rfc4515Parser.AttributedescriptionContext;
import com.github.pms1.ldap.Rfc4515Parser.FilterContext;
import com.github.pms1.ldap.Rfc4515Parser.FilterEOFContext;
import com.github.pms1.ldap.Rfc4515Parser.FiltercompContext;
import com.github.pms1.ldap.Rfc4515Parser.FilterlistContext;
import com.github.pms1.ldap.Rfc4515Parser.FiltertypeContext;
import com.github.pms1.ldap.Rfc4515Parser.ItemContext;
import com.github.pms1.ldap.Rfc4515Parser.NotContext;
import com.github.pms1.ldap.Rfc4515Parser.OrContext;
import com.github.pms1.ldap.Rfc4515Parser.SimpleContext;

public class SearchFilterParser {
	private final boolean lenient;

	public SearchFilterParser() {
<span class="nc" id="L30">		this(false);</span>
<span class="nc" id="L31">	}</span>

<span class="nc" id="L33">	private SearchFilterParser(boolean lenient) {</span>
<span class="nc" id="L34">		this.lenient = lenient;</span>
<span class="nc" id="L35">	}</span>

	public SearchFilterParser lenient() {
<span class="nc" id="L38">		return new SearchFilterParser(true);</span>
	}

	public SearchFilter parse(String searchFilter) {
<span class="nc" id="L42">		BaseErrorListener errorListener = new BaseErrorListener() {</span>
			@Override
			public void syntaxError(Recognizer&lt;?, ?&gt; recognizer, Object offendingSymbol, int line,
					int charPositionInLine, String msg, RecognitionException e) {

<span class="nc" id="L47">				throw new SearchFilterParseException(</span>
						&quot;expression '&quot; + searchFilter + &quot;':&quot; + line + &quot;:&quot; + charPositionInLine + &quot;: &quot; + msg, e);
			};
		};

<span class="nc" id="L52">		Lexer lexer = new Rfc4515Lexer(new ANTLRInputStream(searchFilter));</span>
<span class="nc" id="L53">		lexer.removeErrorListeners();</span>
<span class="nc" id="L54">		lexer.addErrorListener(errorListener);</span>
<span class="nc" id="L55">		CommonTokenStream tokens = new CommonTokenStream(lexer);</span>
<span class="nc" id="L56">		Rfc4515Parser parser = new Rfc4515Parser(tokens);</span>
<span class="nc" id="L57">		parser.lenient = lenient;</span>
<span class="nc" id="L58">		parser.removeErrorListeners();</span>
<span class="nc" id="L59">		parser.addErrorListener(errorListener);</span>

<span class="nc" id="L61">		FilterEOFContext tree = parser.filterEOF();</span>

<span class="nc" id="L63">		return translate(tree);</span>
	}

	private SearchFilter translate(FilterEOFContext context) {
<span class="nc" id="L67">		return translate(context.filter());</span>
	}

	private SearchFilter translate(FilterContext context) {
<span class="nc" id="L71">		return translate(context.filtercomp());</span>
	}

	private SearchFilter translate(FiltercompContext context) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">		if (context.and() != null) {</span>
<span class="nc" id="L76">			return translate(context.and());</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">		} else if (context.or() != null) {</span>
<span class="nc" id="L78">			return translate(context.or());</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">		} else if (context.not() != null) {</span>
<span class="nc" id="L80">			return translate(context.not());</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">		} else if (context.item() != null) {</span>
<span class="nc" id="L82">			return translate(context.item());</span>
		} else {
<span class="nc" id="L84">			throw new IllegalStateException();</span>
		}
	}

	private SearchFilter translate(ItemContext context) {
<span class="nc bnc" id="L89" title="All 2 branches missed.">		if (context.simple() != null) {</span>
<span class="nc" id="L90">			return translate(context.simple());</span>
		} else {
<span class="nc" id="L92">			throw new IllegalStateException();</span>
		}

	}

	private SearchFilter translate(SimpleContext simple) {
<span class="nc" id="L98">		Attribute attribute = translate(simple.attr());</span>
<span class="nc" id="L99">		FilterType filterType = translate(simple.filtertype());</span>
<span class="nc" id="L100">		return new SimpleSearchFilter(attribute, filterType, simple.assertionvalue().getText());</span>
	}

	private FilterType translate(FiltertypeContext filtertype) {
<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (filtertype.equal() != null)</span>
<span class="nc" id="L105">			return FilterType.EQUAL;</span>
<span class="nc" id="L106">		throw new IllegalStateException();</span>
	}

	private Attribute translate(AttrContext attr) {
<span class="nc" id="L110">		return translate(attr.attributedescription());</span>
	}

	private Attribute translate(AttributedescriptionContext attributedescription) {
<span class="nc bnc" id="L114" title="All 2 branches missed.">		if (attributedescription.attributetype().oid() == null)</span>
<span class="nc" id="L115">			throw new IllegalStateException();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">		if (attributedescription.attributetype().oid().descr() == null)</span>
<span class="nc" id="L117">			throw new IllegalStateException();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (attributedescription.attributetype().oid().descr().keystring() == null)</span>
<span class="nc" id="L119">			throw new IllegalStateException();</span>

<span class="nc" id="L121">		String attribute = attributedescription.attributetype().oid().descr().keystring().getText();</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">		if (!attributedescription.options().children.isEmpty())</span>
<span class="nc" id="L124">			throw new IllegalStateException(&quot;&quot; + attributedescription.options().getTokens(0));</span>

<span class="nc" id="L126">		return new AttributeDescription(attribute);</span>
	}

	private SearchFilter translate(AndContext context) {
<span class="nc" id="L130">		return new AndSearchFilter(translate(context.filterlist()));</span>
	}

	private SearchFilter translate(OrContext context) {
<span class="nc" id="L134">		return new OrSearchFilter(translate(context.filterlist()));</span>
	}

	private SearchFilter translate(NotContext context) {
<span class="nc" id="L138">		return new NotSearchFilter(translate(context.filter()));</span>
	}

	private List&lt;SearchFilter&gt; translate(FilterlistContext context) {
<span class="nc" id="L142">		return context.filter().stream().map(this::translate).collect(Collectors.toList());</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>