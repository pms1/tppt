<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DeploymentHelper.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">tppt-maven-plugin</a> &gt; <a href="../index.html" class="el_bundle">tppt-core</a> &gt; <a href="index.source.html" class="el_package">com.github.pms1.tppt.core</a> &gt; <span class="el_source">DeploymentHelper.java</span></div><h1>DeploymentHelper.java</h1><pre class="source lang-java linenums">package com.github.pms1.tppt.core;

import java.io.File;
import java.io.IOException;
import java.nio.file.FileSystem;
import java.nio.file.FileSystems;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeFormatterBuilder;
import java.time.temporal.ChronoField;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeSet;
import java.util.function.Function;
import java.util.regex.Pattern;

import org.apache.maven.model.Plugin;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.project.MavenProject;
import org.codehaus.plexus.component.annotations.Component;
import org.codehaus.plexus.component.annotations.Requirement;
import org.codehaus.plexus.util.xml.Xpp3Dom;

import com.github.pms1.tppt.core.InterpolatedString.Visitor;
import com.github.pms1.tppt.p2.ArtifactId;
import com.github.pms1.tppt.p2.ArtifactRepositoryFacade;
import com.github.pms1.tppt.p2.CommonP2Repository;
import com.github.pms1.tppt.p2.DataCompression;
import com.github.pms1.tppt.p2.P2CompositeRepository;
import com.github.pms1.tppt.p2.P2Repository;
import com.github.pms1.tppt.p2.P2RepositoryFactory;
import com.github.pms1.tppt.p2.P2RepositoryFactory.P2IndexType;
import com.github.pms1.tppt.p2.P2RepositoryVisitor;
import com.github.pms1.tppt.p2.PathByteSource;
import com.github.pms1.tppt.p2.RepositoryFacade;
import com.google.common.base.Joiner;
import com.google.common.base.Preconditions;
import com.google.common.collect.Sets;
import com.google.common.io.ByteSource;

@Component(role = DeploymentHelper.class)
<span class="nc" id="L50">public class DeploymentHelper {</span>
	@Requirement
	private P2RepositoryFactory factory;

	private LocalDateTime extractP2Timestamp(Path root) throws IOException {
<span class="nc" id="L55">		try (FileSystem fs = FileSystems.newFileSystem(root, null)) {</span>

<span class="nc" id="L57">			CommonP2Repository repo = factory.loadAny(fs.getPath(&quot;/&quot;));</span>

<span class="nc" id="L59">			RepositoryFacade&lt;?&gt; artifactRepositoryFacade = repo.getArtifactRepositoryFacade();</span>

<span class="nc" id="L61">			long ts_ms = artifactRepositoryFacade.getTimestamp();</span>

<span class="nc" id="L63">			return LocalDateTime.ofEpochSecond(ts_ms / 1000, (int) (ts_ms % 1000) * 1000000, ZoneOffset.UTC);</span>
<span class="nc bnc" id="L64" title="All 8 branches missed.">		}</span>
	}

	private String getLayout(MavenProject p) {
<span class="nc" id="L68">		Plugin plugin = p.getPlugin(&quot;com.github.pms1.tppt:tppt-maven-plugin&quot;);</span>

<span class="nc" id="L70">		Xpp3Dom configuration = (Xpp3Dom) plugin.getConfiguration();</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">		Xpp3Dom layout = configuration != null ? configuration.getChild(&quot;layout&quot;) : null;</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">		if (layout == null)</span>
<span class="nc" id="L73">			return &quot;@{artifactId}-@{version}-@{timestamp}&quot;;</span>
		else
<span class="nc" id="L75">			return layout.getValue();</span>
	}

	public Path getPath(MavenProject p) throws MojoExecutionException {
		try {
<span class="nc" id="L80">			return getPath(p, extractP2Timestamp(p.getArtifact().getFile().toPath()));</span>
<span class="nc" id="L81">		} catch (IOException e1) {</span>
<span class="nc" id="L82">			throw new MojoExecutionException(&quot;foo&quot;, e1);</span>
		}
	}

	public Path getPath(MavenProject p, LocalDateTime timestamp) throws MojoExecutionException {
<span class="nc" id="L87">		Preconditions.checkNotNull(p);</span>

<span class="nc" id="L89">		String layout = getLayout(p);</span>
<span class="nc" id="L90">		InterpolatedString layout1 = InterpolatedString.parse(layout);</span>
<span class="nc" id="L91">		Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();</span>
<span class="nc" id="L92">		context.put(&quot;group&quot;, p.getGroupId());</span>
<span class="nc" id="L93">		context.put(&quot;artifactId&quot;, p.getArtifactId());</span>
<span class="nc" id="L94">		context.put(&quot;version&quot;, p.getVersion());</span>
<span class="nc" id="L95">		context.put(&quot;timestamp&quot;, timestamp);</span>

<span class="nc" id="L97">		return Paths.get(interpolate(layout1, context));</span>
	}

	public RepositoryPathPattern getPathPattern(MavenProject p) {
<span class="nc" id="L101">		Preconditions.checkNotNull(p);</span>

<span class="nc" id="L103">		String layout = getLayout(p);</span>
<span class="nc" id="L104">		InterpolatedString layout1 = InterpolatedString.parse(layout);</span>
<span class="nc" id="L105">		Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();</span>
<span class="nc" id="L106">		context.put(&quot;group&quot;, p.getGroupId());</span>
<span class="nc" id="L107">		context.put(&quot;artifactId&quot;, p.getArtifactId());</span>
<span class="nc" id="L108">		context.put(&quot;version&quot;, p.getVersion());</span>
<span class="nc" id="L109">		context.put(&quot;timestamp&quot;, LocalDateTime.class);</span>

<span class="nc" id="L111">		return interpolatePattern(layout1, context);</span>
	}

	private String interpolate(InterpolatedString layout1, Map&lt;String, Object&gt; context) {
<span class="nc" id="L115">		StringBuilder b = new StringBuilder();</span>

<span class="nc" id="L117">		layout1.accept(new Visitor() {</span>

			@Override
			public void visitText(String text) {
<span class="nc" id="L121">				b.append(text);</span>
<span class="nc" id="L122">			}</span>

			@Override
			public void visitVariable(List&lt;String&gt; variable) {
<span class="nc" id="L126">				Object o = context.get(variable.get(0));</span>
				String s;
<span class="nc bnc" id="L128" title="All 2 branches missed.">				if (o == null) {</span>
<span class="nc" id="L129">					throw new IllegalArgumentException(&quot;No variable: &quot; + variable.get(0));</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">				} else if (o.getClass() == String.class) {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">					if (variable.size() != 1)</span>
<span class="nc" id="L132">						throw new IllegalArgumentException();</span>
<span class="nc" id="L133">					s = o.toString();</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">				} else if (o.getClass() == LocalDateTime.class) {</span>
					DateTimeFormatter formatter;
<span class="nc bnc" id="L136" title="All 2 branches missed.">					if (variable.size() == 1)</span>
<span class="nc" id="L137">						formatter = defaultFormatter;</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">					else if (variable.size() == 2)</span>
<span class="nc" id="L139">						formatter = DateTimeFormatter.ofPattern(variable.get(1));</span>
					else
<span class="nc" id="L141">						throw new IllegalArgumentException();</span>
<span class="nc" id="L142">					s = formatter.format((LocalDateTime) o);</span>
<span class="nc" id="L143">				} else {</span>
<span class="nc" id="L144">					throw new IllegalArgumentException();</span>
				}
<span class="nc" id="L146">				b.append(s);</span>
<span class="nc" id="L147">			}</span>

		});

<span class="nc" id="L151">		return b.toString();</span>
	}

<span class="nc" id="L154">	static private final Joiner pathJoiner = Joiner.on(&quot;/&quot;);</span>

	// should be: &lt;code&gt;DateTimeFormatter.ofPattern(&quot;yyyyMMddHHmmssSSS&quot;)&lt;/code&gt;
	// but see https://bugs.openjdk.java.net/browse/JDK-8031085
<span class="nc" id="L158">	static private final DateTimeFormatter defaultFormatter = new DateTimeFormatterBuilder()</span>
<span class="nc" id="L159">			.appendPattern(&quot;yyyyMMddHHmmss&quot;).appendValue(ChronoField.MILLI_OF_SECOND, 3).toFormatter();</span>

	static private final String defaultFormatterRegexp = &quot;\\d{17}&quot;;

	private RepositoryPathPattern interpolatePattern(InterpolatedString layout1, Map&lt;String, Object&gt; context) {
<span class="nc" id="L164">		StringBuilder b = new StringBuilder();</span>

<span class="nc" id="L166">		Map&lt;String, Function&lt;String, Object&gt;&gt; postProcessors = new HashMap&lt;&gt;();</span>

<span class="nc" id="L168">		layout1.accept(new Visitor() {</span>

			@Override
			public void visitText(String text) {
<span class="nc" id="L172">				b.append(Pattern.quote(text));</span>
<span class="nc" id="L173">			}</span>

			@Override
			public void visitVariable(List&lt;String&gt; variable) {
<span class="nc" id="L177">				Object o = context.get(variable.get(0));</span>

<span class="nc bnc" id="L179" title="All 2 branches missed.">				if (o == null) {</span>
<span class="nc" id="L180">					throw new IllegalArgumentException(&quot;No variable: &quot; + variable.get(0));</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">				} else if (o.getClass() == String.class) {</span>
<span class="nc" id="L182">					b.append(Pattern.quote((String) o));</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">				} else if (o == LocalDateTime.class) {</span>
					DateTimeFormatter formatter;
					String regexp;

<span class="nc bnc" id="L187" title="All 2 branches missed.">					if (variable.size() == 1) {</span>
<span class="nc" id="L188">						formatter = defaultFormatter;</span>
<span class="nc" id="L189">						regexp = defaultFormatterRegexp;</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">					} else if (variable.size() == 2) {</span>
<span class="nc" id="L191">						formatter = DateTimeFormatter.ofPattern(variable.get(1));</span>
<span class="nc" id="L192">						regexp = asRegularExpression(variable.get(1));</span>
					} else {
<span class="nc" id="L194">						throw new IllegalArgumentException();</span>
					}

<span class="nc bnc" id="L197" title="All 2 branches missed.">					postProcessors.put(variable.get(0), p -&gt; p == null ? null : LocalDateTime.parse(p, formatter));</span>
<span class="nc" id="L198">					b.append(&quot;(?&lt;&quot; + variable.get(0) + &quot;&gt;&quot; + regexp + &quot;)&quot;);</span>
<span class="nc" id="L199">				} else {</span>
<span class="nc" id="L200">					throw new IllegalArgumentException();</span>
				}
<span class="nc" id="L202">			}</span>

		});

<span class="nc" id="L206">		Pattern pattern = Pattern.compile(b.toString());</span>

<span class="nc" id="L208">		return new RepositoryPathPattern() {</span>

			@Override
			public RepositoryPathMatcher matcher(Path path) {

<span class="nc" id="L213">				return new RepositoryPathMatcher() {</span>

					java.util.regex.Matcher m;

					@Override
					public boolean matches() {
<span class="nc" id="L219">						m = pattern.matcher(pathJoiner.join(path));</span>
<span class="nc" id="L220">						return m.matches();</span>
					}

					@Override
					public &lt;T&gt; T get(String variable, Class&lt;T&gt; type) {
<span class="nc bnc" id="L225" title="All 2 branches missed.">						if (m == null)</span>
<span class="nc" id="L226">							throw new IllegalStateException();</span>
<span class="nc" id="L227">						return type.cast(postProcessors.get(variable).apply(m.group(variable)));</span>
					}

				};
			}
		};

	}

	private Set&lt;String&gt; getFiles(CommonP2Repository repo) throws IOException {
<span class="nc" id="L237">		Set&lt;String&gt; files = new TreeSet&lt;&gt;();</span>

<span class="nc" id="L239">		files.add(P2RepositoryFactory.P2INDEX);</span>

<span class="nc" id="L241">		repo.accept(new P2RepositoryVisitor&lt;Void&gt;() {</span>

			@Override
			public Void visit(P2CompositeRepository repo) {
<span class="nc bnc" id="L245" title="All 2 branches missed.">				for (DataCompression dc : repo.getArtifactDataCompressions())</span>
<span class="nc" id="L246">					files.add(P2IndexType.compositeArtifacts.getFilePrefix() + &quot;.&quot; + dc.getFileSuffix());</span>

<span class="nc bnc" id="L248" title="All 2 branches missed.">				for (DataCompression dc : repo.getMetadataDataCompressions())</span>
<span class="nc" id="L249">					files.add(P2IndexType.compositeMetadata.getFilePrefix() + &quot;.&quot; + dc.getFileSuffix());</span>

<span class="nc" id="L251">				return null;</span>
			}

			@Override
			public Void visit(P2Repository repo) {
<span class="nc bnc" id="L256" title="All 2 branches missed.">				for (DataCompression dc : repo.getArtifactDataCompressions())</span>
<span class="nc" id="L257">					files.add(P2IndexType.artifacts.getFilePrefix() + &quot;.&quot; + dc.getFileSuffix());</span>

<span class="nc bnc" id="L259" title="All 2 branches missed.">				for (DataCompression dc : repo.getMetadataDataCompressions())</span>
<span class="nc" id="L260">					files.add(P2IndexType.metadata.getFilePrefix() + &quot;.&quot; + dc.getFileSuffix());</span>

				try {
					ArtifactRepositoryFacade facade;
<span class="nc" id="L264">					facade = repo.getArtifactRepositoryFacade();</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">					for (ArtifactId e : facade.getArtifacts().keySet())</span>
<span class="nc" id="L266">						files.add(repo.getPath().relativize(facade.getArtifactUri(e)).toString()</span>
<span class="nc" id="L267">								.replace(File.separatorChar, '/'));</span>
<span class="nc" id="L268">				} catch (IOException e1) {</span>
<span class="nc" id="L269">					throw new RuntimeException(e1);</span>
<span class="nc" id="L270">				}</span>

<span class="nc" id="L272">				return null;</span>
			}
		});

<span class="nc" id="L276">		return files;</span>
	}

	private void doInstall(Path sourcePath, Set&lt;String&gt; sourceFiles, Path targetPath, Set&lt;String&gt; targetFiles)
			throws IOException {

<span class="nc" id="L282">		TreeSet&lt;Path&gt; toRemove = new TreeSet&lt;&gt;();</span>

<span class="nc bnc" id="L284" title="All 2 branches missed.">		for (String p : Sets.union(sourceFiles, targetFiles)) {</span>
<span class="nc" id="L285">			Path p1 = sourcePath.resolve(p);</span>
<span class="nc" id="L286">			Path p2 = targetPath.resolve(p);</span>

<span class="nc" id="L288">			Files.createDirectories(p2.getParent());</span>

<span class="nc bnc" id="L290" title="All 4 branches missed.">			if (sourceFiles.contains(p) &amp;&amp; targetFiles.contains(p)) {</span>
<span class="nc" id="L291">				ByteSource bs1 = new PathByteSource(p1);</span>
<span class="nc" id="L292">				ByteSource bs2 = new PathByteSource(p2);</span>

<span class="nc bnc" id="L294" title="All 2 branches missed.">				if (!bs1.contentEquals(bs2)) {</span>
<span class="nc" id="L295">					Files.copy(p1, p2, StandardCopyOption.COPY_ATTRIBUTES, StandardCopyOption.REPLACE_EXISTING);</span>
				} else {
					// System.out.println(&quot;UNMODIFIED &quot; + p);
				}
<span class="nc bnc" id="L299" title="All 2 branches missed.">			} else if (sourceFiles.contains(p)) {</span>
<span class="nc" id="L300">				Files.copy(p1, p2, StandardCopyOption.COPY_ATTRIBUTES);</span>
			} else {
<span class="nc" id="L302">				Files.delete(p2);</span>
<span class="nc" id="L303">				toRemove.add(p2.getParent());</span>
			}
<span class="nc" id="L305">		}</span>

		// TODO: remove directories that got empty // toRemove
<span class="nc" id="L308">	}</span>

	public void replace(CommonP2Repository source, CommonP2Repository target) throws IOException {
<span class="nc" id="L311">		Preconditions.checkNotNull(source);</span>
<span class="nc" id="L312">		Preconditions.checkNotNull(target);</span>

<span class="nc" id="L314">		Set&lt;String&gt; f1 = getFiles(source);</span>
<span class="nc" id="L315">		Set&lt;String&gt; f2 = getFiles(target);</span>

<span class="nc" id="L317">		doInstall(source.getPath(), f1, target.getPath(), f2);</span>
<span class="nc" id="L318">	}</span>

	public void install(CommonP2Repository source, Path target) throws IOException {
<span class="nc" id="L321">		Preconditions.checkNotNull(source);</span>
<span class="nc" id="L322">		Preconditions.checkNotNull(target);</span>

<span class="nc" id="L324">		Set&lt;String&gt; f1 = getFiles(source);</span>

<span class="nc" id="L326">		doInstall(source.getPath(), f1, target, Collections.emptySet());</span>

<span class="nc" id="L328">	}</span>

	static String asRegularExpression(String pattern) {
<span class="nc" id="L331">		StringBuilder regex = new StringBuilder();</span>

<span class="nc bnc" id="L333" title="All 2 branches missed.">		for (int i = 0; i != pattern.length();) {</span>
<span class="nc" id="L334">			int start = i;</span>
<span class="nc" id="L335">			char c = pattern.charAt(i++);</span>
<span class="nc bnc" id="L336" title="All 4 branches missed.">			while (i != pattern.length() &amp;&amp; pattern.charAt(i) == c)</span>
<span class="nc" id="L337">				++i;</span>
<span class="nc" id="L338">			String part = pattern.substring(start, i);</span>
<span class="nc bnc" id="L339" title="All 24 branches missed.">			switch (part) {</span>
			case &quot;yyyy&quot;:
			case &quot;yy&quot;:
			case &quot;MM&quot;:
			case &quot;dd&quot;:
			case &quot;HH&quot;:
			case &quot;mm&quot;:
			case &quot;ss&quot;:
<span class="nc" id="L347">				regex.append(&quot;\\d{&quot; + part.length() + &quot;}&quot;);</span>
<span class="nc" id="L348">				break;</span>
			default:
<span class="nc" id="L350">				throw new IllegalArgumentException(&quot;Unhandled part '&quot; + part + &quot;' of pattern '&quot; + pattern + &quot;'&quot;);</span>
			}
<span class="nc" id="L352">		}</span>
<span class="nc" id="L353">		return regex.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>