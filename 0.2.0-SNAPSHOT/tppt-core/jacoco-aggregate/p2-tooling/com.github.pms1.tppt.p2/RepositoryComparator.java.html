<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RepositoryComparator.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">tppt-core</a> &gt; <a href="../index.html" class="el_bundle">p2-tooling</a> &gt; <a href="index.source.html" class="el_package">com.github.pms1.tppt.p2</a> &gt; <span class="el_source">RepositoryComparator.java</span></div><h1>RepositoryComparator.java</h1><pre class="source lang-java linenums">package com.github.pms1.tppt.p2;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.lang.reflect.ParameterizedType;
import java.lang.reflect.Type;
import java.nio.charset.StandardCharsets;
import java.nio.file.Path;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.function.Consumer;
import java.util.function.Function;
import java.util.function.Predicate;
import java.util.function.Supplier;
import java.util.stream.Collectors;

import org.codehaus.plexus.component.annotations.Component;
import org.codehaus.plexus.component.annotations.Requirement;
import org.eclipse.osgi.util.ManifestElement;
import org.osgi.framework.BundleException;
import org.osgi.framework.Version;
import org.osgi.framework.VersionRange;
import org.slf4j.Logger;

import com.github.pms1.ldap.SearchFilter;
import com.github.pms1.ldap.SearchFilterPrinter;
import com.github.pms1.ocomp.ComparatorMatchers;
import com.github.pms1.ocomp.DecomposedObject;
import com.github.pms1.ocomp.Decomposer;
import com.github.pms1.ocomp.DecomposerMatchers;
import com.github.pms1.ocomp.OPathMatcher;
import com.github.pms1.ocomp.ObjectComparator;
import com.github.pms1.ocomp.ObjectComparator.ChangeType;
import com.github.pms1.ocomp.ObjectComparator.DecomposerFactory;
import com.github.pms1.ocomp.ObjectComparator.DeltaCreator;
import com.github.pms1.ocomp.ObjectComparator.OPath;
import com.github.pms1.ocomp.ObjectComparator.OPath2;
import com.github.pms1.ocomp.ObjectComparatorBuilder;
import com.github.pms1.ocomp.ObjectDelta;
import com.github.pms1.tppt.p2.P2RepositoryFactory.P2Kind;
import com.github.pms1.tppt.p2.jaxb.artifact.Artifact;
import com.github.pms1.tppt.p2.jaxb.artifact.ArtifactProperty;
import com.github.pms1.tppt.p2.jaxb.composite.Child;
import com.github.pms1.tppt.p2.jaxb.composite.CompositeProperty;
import com.github.pms1.tppt.p2.jaxb.composite.CompositeRepository;
import com.github.pms1.tppt.p2.jaxb.metadata.Instruction;
import com.github.pms1.tppt.p2.jaxb.metadata.MetadataArtifact;
import com.github.pms1.tppt.p2.jaxb.metadata.MetadataProperty;
import com.github.pms1.tppt.p2.jaxb.metadata.MetadataRepository;
import com.github.pms1.tppt.p2.jaxb.metadata.Provided;
import com.github.pms1.tppt.p2.jaxb.metadata.Required;
import com.github.pms1.tppt.p2.jaxb.metadata.Unit;
import com.google.common.base.Preconditions;
import com.google.common.collect.HashMultimap;
import com.google.common.collect.Iterables;
import com.google.common.collect.Multimap;
import com.google.common.collect.Sets;
import com.google.common.reflect.TypeToken;

@Component(role = RepositoryComparator.class)
<span class="nc" id="L68">public class RepositoryComparator {</span>
	@Requirement
	Logger logger;

	@Requirement
	ArtifactRepositoryFactory artifactRepositoryFactory;

	@Requirement
	MetadataRepositoryFactory metadataRepositoryFactory;

	@Requirement
	Map&lt;String, FileComparator&gt; comparators;

<span class="nc" id="L81">	static private final TypeToken&lt;?&gt; listRequired = new TypeToken&lt;List&lt;Required&gt;&gt;() {</span>

	};

<span class="nc" id="L85">	static private final TypeToken&lt;?&gt; listProvided = new TypeToken&lt;List&lt;Provided&gt;&gt;() {</span>

	};

<span class="nc" id="L89">	static DecomposerFactory listToBag = new DecomposerFactory() {</span>

		@Override
		public &lt;T&gt; Decomposer&lt;T&gt; generate(Type t) {
<span class="nc bnc" id="L93" title="All 2 branches missed.">			if (!(t instanceof ParameterizedType))</span>
<span class="nc" id="L94">				return null;</span>

<span class="nc" id="L96">			ParameterizedType pt = (ParameterizedType) t;</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">			if (!List.class.isAssignableFrom((Class&lt;?&gt;) pt.getRawType()))</span>
<span class="nc" id="L98">				return null;</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">			if (pt.getActualTypeArguments().length != 1)</span>
<span class="nc" id="L100">				throw new IllegalStateException();</span>
<span class="nc" id="L101">			Type et = pt.getActualTypeArguments()[0];</span>

<span class="nc" id="L103">			return o -&gt; {</span>
<span class="nc" id="L104">				DecomposedObject r = new DecomposedObject();</span>

<span class="nc" id="L106">				List&lt;?&gt; l = (List&lt;?&gt;) o;</span>

<span class="nc bnc" id="L108" title="All 2 branches missed.">				for (Object r1 : l) {</span>
<span class="nc" id="L109">					r.put(null, et, r1);</span>
<span class="nc" id="L110">				}</span>

<span class="nc" id="L112">				return r;</span>
			};
		}

	};

	static abstract class AbstractUnitDelta extends FileDelta {
		protected final Unit left;
		protected final Unit right;

		AbstractUnitDelta(FileId id1, Unit left, FileId id2, Unit right, String message, Object... parameters) {
<span class="nc" id="L123">			super(id1, id2, message, parameters);</span>
<span class="nc" id="L124">			Preconditions.checkNotNull(left);</span>
<span class="nc" id="L125">			this.left = left;</span>
<span class="nc" id="L126">			Preconditions.checkNotNull(right);</span>
<span class="nc" id="L127">			this.right = right;</span>
<span class="nc" id="L128">		}</span>
	}

	static abstract class AbstractArtifactDelta extends FileDelta {
		protected final Artifact left;
		protected final Artifact right;

		AbstractArtifactDelta(FileId id1, Artifact left, FileId id2, Artifact right, String message,
				Object... parameters) {
<span class="nc" id="L137">			super(id1, id2, message, parameters);</span>
<span class="nc" id="L138">			Preconditions.checkNotNull(left);</span>
<span class="nc" id="L139">			this.left = left;</span>
<span class="nc" id="L140">			Preconditions.checkNotNull(right);</span>
<span class="nc" id="L141">			this.right = right;</span>
<span class="nc" id="L142">		}</span>
	}

	static class UnitDelta extends AbstractUnitDelta {
		final OPath2 path;

		UnitDelta(FileId id1, Unit left, FileId id2, Unit right, OPath2 path) {
<span class="nc" id="L149">			super(id1, left, id2, right, &quot;Unit changed {0} -&gt; {1}: {2}: {3} -&gt; {4}&quot;, left, right, path.getPath(),</span>
<span class="nc" id="L150">					path.getLeft(), path.getRight());</span>
<span class="nc" id="L151">			this.path = path;</span>
<span class="nc" id="L152">		}</span>
	}

	static class ArtifactDelta extends AbstractArtifactDelta {
		final OPath2 path;

		ArtifactDelta(FileId id1, Artifact left, FileId id2, Artifact right, OPath2 path) {
<span class="nc" id="L159">			super(id1, left, id2, right, &quot;Artifact changed {0} -&gt; {1}: {2}: {3} -&gt; {4}&quot;, left, right, path.getPath(),</span>
<span class="nc" id="L160">					path.getLeft(), path.getRight());</span>
<span class="nc" id="L161">			this.path = path;</span>
<span class="nc" id="L162">		}</span>
	}

	static class ProvidedAdded extends AbstractUnitDelta {
		final Provided provided;

		ProvidedAdded(FileId id1, Unit left, FileId id2, Unit right, Provided provided) {
<span class="nc" id="L169">			super(id1, left, id2, right, &quot;Provided added: {0} -&gt; {1}: {2}&quot;, left, right, provided);</span>
<span class="nc" id="L170">			Preconditions.checkNotNull(provided);</span>
<span class="nc" id="L171">			this.provided = provided;</span>
<span class="nc" id="L172">		}</span>

	}

	static class RequiredAdded extends AbstractUnitDelta {
		final Required required;

		RequiredAdded(FileId id1, Unit left, FileId id2, Unit right, Required required) {
<span class="nc" id="L180">			super(id1, left, id2, right, &quot;Required added: {0} -&gt; {1}: {2}&quot;, left, right, required);</span>
<span class="nc" id="L181">			Preconditions.checkNotNull(required);</span>
<span class="nc" id="L182">			this.required = required;</span>
<span class="nc" id="L183">		}</span>

	}

	static class ProvidedRemoved extends AbstractUnitDelta {
		final Provided provided;

		ProvidedRemoved(FileId id1, Unit left, FileId id2, Unit right, Provided provided) {
<span class="nc" id="L191">			super(id1, left, id2, right, &quot;Provided removed: {0} -&gt; {1}: {2}&quot;, left, right, provided);</span>
<span class="nc" id="L192">			Preconditions.checkNotNull(provided);</span>
<span class="nc" id="L193">			this.provided = provided;</span>
<span class="nc" id="L194">		}</span>
	}

	static class RequiredRemoved extends AbstractUnitDelta {
		final Required required;

		RequiredRemoved(FileId id1, Unit left, FileId id2, Unit right, Required required) {
<span class="nc" id="L201">			super(id1, left, id2, right, &quot;Required removed: {0} -&gt; {1}: {2}&quot;, left, right, required);</span>

<span class="nc" id="L203">			Preconditions.checkNotNull(required);</span>
<span class="nc" id="L204">			this.required = required;</span>
<span class="nc" id="L205">		}</span>
	}

	static class RepositoryTimestampDelta extends FileDelta {
		RepositoryTimestampDelta(FileId id1, long left, FileId id2, long right) {
<span class="nc" id="L210">			super(id1, id2, &quot;Repository timestamp changed: {0} -&gt; {1}&quot;, left, right);</span>
<span class="nc" id="L211">		}</span>

	}

	static class RepositoryAdded extends FileDelta {
		RepositoryAdded(FileId id1, Child left, FileId id2, Child right) {
<span class="nc" id="L217">			super(id1, id2, &quot;Repository added: {0}&quot;, right);</span>
<span class="nc" id="L218">		}</span>

	}

	static class RepositoryRemoved extends FileDelta {
		RepositoryRemoved(FileId id1, Child left, FileId id2, Child right) {
<span class="nc" id="L224">			super(id1, id2, &quot;Repository removed: {0}&quot;, left);</span>
<span class="nc" id="L225">		}</span>

	}

<span class="nc" id="L229">	static final SearchFilterPrinter printer = new SearchFilterPrinter();</span>

	static ObjectComparatorBuilder&lt;ObjectDelta&gt; createArtifactComparator() {
<span class="nc" id="L232">		return ObjectComparatorBuilder.newBuilder() //</span>
<span class="nc" id="L233">				.addDecomposer(&quot;//artifacts/artifact&quot;, new Decomposer&lt;List&lt;Artifact&gt;&gt;() {</span>

					DecomposedObject dc1(List&lt;Artifact&gt; units, Function&lt;Artifact, String&gt; f) {
<span class="nc" id="L236">						DecomposedObject r = new DecomposedObject();</span>

<span class="nc bnc" id="L238" title="All 2 branches missed.">						for (Artifact u : units) {</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">							if (!r.put(OPath.index(f.apply(u)), u))</span>
<span class="nc" id="L240">								return null;</span>
<span class="nc" id="L241">						}</span>

<span class="nc" id="L243">						return r;</span>
					}

					@Override
					public DecomposedObject decompose(List&lt;Artifact&gt; o) {
						DecomposedObject r;

<span class="nc" id="L250">						r = dc1(o, p -&gt; p.getId());</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">						if (r != null)</span>
<span class="nc" id="L252">							return r;</span>

<span class="nc" id="L254">						r = dc1(o, p -&gt; p.getId() + &quot;/&quot; + p.getVersion());</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">						if (r != null)</span>
<span class="nc" id="L256">							return r;</span>

<span class="nc" id="L258">						throw new Error();</span>
					}

				}) //
<span class="nc" id="L262">				.addDecomposer(&quot;//artifacts/artifact[*]/properties/property&quot;,</span>
<span class="nc" id="L263">						ObjectComparator.&lt;ArtifactProperty&gt;listToMapDecomposer(p -&gt; p.getName())) //</span>
<span class="nc" id="L264">				.addDecomposer(&quot;//properties/property&quot;,</span>
<span class="nc" id="L265">						ObjectComparator.&lt;ArtifactProperty&gt;listToMapDecomposer(p -&gt; p.getName()));</span>
	}

	static ObjectComparatorBuilder&lt;ObjectDelta&gt; createMetadataComparator() {
<span class="nc" id="L269">		return ObjectComparatorBuilder.newBuilder()</span>
<span class="nc" id="L270">				.addComparator(ComparatorMatchers.isAssignable(TypeToken.of(SearchFilter.class)), (a, b) -&gt; {</span>
<span class="nc" id="L271">					return printer.print((SearchFilter) a).equals(printer.print((SearchFilter) b));</span>
<span class="nc" id="L272">				}).addDecomposer(DecomposerMatchers.isAssignable(listRequired), listToBag)</span>
<span class="nc" id="L273">				.addDecomposer(DecomposerMatchers.isAssignable(listProvided), listToBag)</span>
<span class="nc" id="L274">				.addDecomposer(&quot;//units/unit[*]/touchpointData/instructions[*]/instruction[manifest]/value&quot;,</span>
<span class="nc" id="L275">						new Decomposer&lt;String&gt;() {</span>

							@Override
							public DecomposedObject decompose(String value) {

								try {
<span class="nc" id="L281">									Map&lt;String, String&gt; ml = ManifestElement.parseBundleManifest(</span>
<span class="nc" id="L282">											new ByteArrayInputStream(value.trim().getBytes(StandardCharsets.UTF_8)),</span>
											null);

<span class="nc" id="L285">									DecomposedObject decomposedObject = new DecomposedObject();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">									for (Map.Entry&lt;String, String&gt; e : ml.entrySet()) {</span>
<span class="nc" id="L287">										decomposedObject.put(OPath.index(e.getKey()), e.getValue());</span>
<span class="nc" id="L288">									}</span>
<span class="nc" id="L289">									return decomposedObject;</span>
<span class="nc" id="L290">								} catch (IOException | BundleException e) {</span>
<span class="nc" id="L291">									throw new RuntimeException(e);</span>
								}
							}

						})
<span class="nc" id="L296">				.addDecomposer(&quot;//units/unit&quot;, new Decomposer&lt;List&lt;Unit&gt;&gt;() {</span>

					DecomposedObject dc1(List&lt;Unit&gt; units, Function&lt;Unit, String&gt; f) {
<span class="nc" id="L299">						DecomposedObject r = new DecomposedObject();</span>

<span class="nc bnc" id="L301" title="All 2 branches missed.">						for (Unit u : units) {</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">							if (!r.put(OPath.index(f.apply(u)), u))</span>
<span class="nc" id="L303">								return null;</span>
<span class="nc" id="L304">						}</span>

<span class="nc" id="L306">						return r;</span>
					}

					@Override
					public DecomposedObject decompose(List&lt;Unit&gt; o) {
						DecomposedObject r;

<span class="nc" id="L313">						r = dc1(o, p -&gt; p.getId());</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">						if (r != null)</span>
<span class="nc" id="L315">							return r;</span>

<span class="nc" id="L317">						r = dc1(o, p -&gt; p.getId() + &quot;/&quot; + p.getVersion());</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">						if (r != null)</span>
<span class="nc" id="L319">							return r;</span>

<span class="nc" id="L321">						throw new Error();</span>
					}

				})
				// ObjectComparator.&lt;Unit&gt;listToMapDecomposer(p -&gt; p.getId() +
				// &quot;/&quot; +
				// p.getVersion()))
<span class="nc" id="L328">				.addDecomposer(&quot;//units/unit[*]/touchpointData/instructions[*]/instruction&quot;,</span>
<span class="nc" id="L329">						ObjectComparator.&lt;Instruction&gt;listToMapDecomposer(p -&gt; p.getKey()))</span>
<span class="nc" id="L330">				.addDecomposer(&quot;//units/unit[*]/artifacts/artifact&quot;,</span>
						ObjectComparator
<span class="nc" id="L332">								.&lt;MetadataArtifact&gt;listToMapDecomposer(p -&gt; p.getId() + &quot;/&quot; + p.getClassifier()))</span>
<span class="nc" id="L333">				.addDecomposer(&quot;//properties/property&quot;,</span>
<span class="nc" id="L334">						ObjectComparator.&lt;MetadataProperty&gt;listToMapDecomposer(p -&gt; p.getName()));</span>
	}

	static class MetadataDelta extends FileDelta {
		public MetadataDelta(FileId id1, FileId id2, OPath2 p, ChangeType change) {
<span class="nc" id="L339">			super(id1, id2, &quot;Metadata change {0} {1}: {2} -&gt; {3}&quot;, p.getPath(), change, p.getLeft(), p.getRight());</span>
<span class="nc" id="L340">			Preconditions.checkNotNull(p);</span>
<span class="nc" id="L341">			Preconditions.checkNotNull(change);</span>
<span class="nc" id="L342">		}</span>
	}

	static class CompositeDelta extends FileDelta {
		public CompositeDelta(FileId id1, FileId id2, OPath2 p, ChangeType change) {
<span class="nc" id="L347">			super(id1, id2, &quot;Composite change {0} {1}: {2} -&gt; {3}&quot;, p.getPath(), change, p.getLeft(), p.getRight());</span>
<span class="nc" id="L348">			Preconditions.checkNotNull(p);</span>
<span class="nc" id="L349">			Preconditions.checkNotNull(change);</span>
<span class="nc" id="L350">		}</span>
	}

	static class ArtifactsDelta extends FileDelta {
		public ArtifactsDelta(FileId id1, FileId id2, OPath2 p, ChangeType change) {
<span class="nc" id="L355">			super(id1, id2, &quot;Artifacts change {0} {1}: {2} -&gt; {3}&quot;, p.getPath(), change, p.getLeft(), p.getRight());</span>
<span class="nc" id="L356">			Preconditions.checkNotNull(p);</span>
<span class="nc" id="L357">			Preconditions.checkNotNull(change);</span>
<span class="nc" id="L358">		}</span>
	}

	private void compare(FileId root1, List&lt;DataCompression&gt; s1, FileId root2, List&lt;DataCompression&gt; s2, P2Kind prefix,
			Consumer&lt;FileDelta&gt; dest) {

<span class="nc bnc" id="L364" title="All 2 branches missed.">		if (!Objects.equals(s1, s2))</span>
<span class="nc" id="L365">			dest.accept(new RepositoryDataCompressionChanged(root1, root2, prefix, s1, s2));</span>
<span class="nc" id="L366">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	public final boolean run(P2Repository pr1, P2Repository pr2) throws IOException {
<span class="nc" id="L370">		return run(pr1, pr2, new Supplier[0]);</span>
	}

	@SafeVarargs
	public final boolean run(CommonP2Repository pr1, CommonP2Repository pr2, Supplier&lt;Change&gt;... acceptedChanges)
			throws IOException {
<span class="nc bnc" id="L376" title="All 2 branches missed.">		if (pr1.getClass() != pr2.getClass()) {</span>
			// FIXME: path
<span class="nc" id="L378">			logger.info(&quot;Repository type changed&quot;);</span>
<span class="nc" id="L379">			return false;</span>
		}

<span class="nc" id="L382">		return pr1.accept(new P2RepositoryVisitor&lt;Boolean&gt;() {</span>

			@Override
			public Boolean visit(P2CompositeRepository repo) {
				try {
<span class="nc" id="L387">					return run((P2CompositeRepository) pr1, (P2CompositeRepository) pr2, acceptedChanges);</span>
<span class="nc" id="L388">				} catch (IOException e) {</span>
<span class="nc" id="L389">					throw new RuntimeException(e);</span>
				}
			}

			@Override
			public Boolean visit(P2Repository repo) {
				try {
<span class="nc" id="L396">					return run((P2Repository) pr1, (P2Repository) pr2, acceptedChanges);</span>
<span class="nc" id="L397">				} catch (IOException e) {</span>
<span class="nc" id="L398">					throw new RuntimeException(e);</span>
				}
			}
		});
	}

	private boolean run(P2CompositeRepository pr1, P2CompositeRepository pr2,
			@SuppressWarnings(&quot;unchecked&quot;) Supplier&lt;Change&gt;... acceptedChanges) throws IOException {
<span class="nc" id="L406">		List&lt;FileDelta&gt; dest = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L408">		FileId root1 = FileId.newRoot(pr1.getPath());</span>
<span class="nc" id="L409">		FileId root2 = FileId.newRoot(pr2.getPath());</span>

<span class="nc" id="L411">		compare(root1, pr1.getArtifactDataCompressions(), root2, pr2.getArtifactDataCompressions(), P2Kind.artifact,</span>
				dest::add);
<span class="nc" id="L413">		compare(root1, pr1.getMetadataDataCompressions(), root2, pr2.getMetadataDataCompressions(), P2Kind.metadata,</span>
				dest::add);

<span class="nc" id="L416">		CompositeRepositoryFacade arf1 = pr1.getArtifactRepositoryFacade();</span>
<span class="nc" id="L417">		FileId arf1id = FileId.newRoot(arf1.getPath());</span>
<span class="nc" id="L418">		CompositeRepositoryFacade arf2 = pr2.getArtifactRepositoryFacade();</span>
<span class="nc" id="L419">		FileId arf2id = FileId.newRoot(arf2.getPath());</span>

<span class="nc" id="L421">		CompositeRepository ar1 = arf1.getRepository();</span>
<span class="nc" id="L422">		CompositeRepository ar2 = arf2.getRepository();</span>
		// MetadataRepositoryFacade mdf1 = pr1.getMetadataRepositoryFacade();
		// FileId mdf1id = FileId.newRoot(mdf1.getPath());
		// MetadataRepositoryFacade mdf2 = pr2.getMetadataRepositoryFacade();
		// FileId mdf2id = FileId.newRoot(mdf2.getPath());
		//
		// MetadataRepository md1 = mdf1.getRepository();
		// MetadataRepository md2 = mdf2.getRepository();
		//
		// ArtifactRepositoryFacade r1 = pr1.getArtifactRepositoryFacade();
		// FileId r1id = FileId.newRoot(r1.getPath());
		// ArtifactRepositoryFacade r2 = pr2.getArtifactRepositoryFacade();
		// FileId r2id = FileId.newRoot(r2.getPath());

<span class="nc" id="L436">		ObjectComparator&lt;FileDelta&gt; oc = ObjectComparatorBuilder.newBuilder() //</span>
<span class="nc" id="L437">				.addDecomposer(&quot;//properties/property&quot;,</span>
<span class="nc" id="L438">						ObjectComparator.&lt;CompositeProperty&gt;listToMapDecomposer(CompositeProperty::getName)) //</span>
<span class="nc" id="L439">				.addDecomposer(&quot;//children/child&quot;, ObjectComparator.&lt;Child&gt;listToMapDecomposer(Child::getLocation)) //</span>
<span class="nc" id="L440">				.setDeltaCreator(new DeltaCreator&lt;FileDelta&gt;() {</span>

					@Override
					public FileDelta changed(OPath2 p, ChangeType change, Object m1, Object m2) {
<span class="nc bnc" id="L444" title="All 2 branches missed.">						if (p.size() &gt; 3) {</span>
<span class="nc" id="L445">							OPath2 unitPath = p.subPath(0, 3);</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">							if (unitPath.getPath().equals(&quot;//children/child&quot;)) {</span>
<span class="nc bnc" id="L447" title="All 3 branches missed.">								switch (change) {</span>
								case ADDED:
<span class="nc" id="L449">									return new RepositoryAdded(arf1id, (Child) m1, arf2id, (Child) m2);</span>
								case REMOVED:
<span class="nc" id="L451">									return new RepositoryRemoved(arf1id, (Child) m1, arf2id, (Child) m2);</span>
								default:
<span class="nc" id="L453">									throw new Error(p + &quot; &quot; + change + &quot; &quot; + m1 + &quot; &quot; + m2);</span>
								}
							}
						}
<span class="nc bnc" id="L457" title="All 6 branches missed.">						switch (p.getPath()) {</span>
						case &quot;//properties/property[p2.timestamp]/value&quot;:
<span class="nc" id="L459">							return new RepositoryTimestampDelta(arf1id, Long.parseLong((String) m1), arf2id,</span>
<span class="nc" id="L460">									Long.parseLong((String) m2));</span>
						}

<span class="nc" id="L463">						return new CompositeDelta(arf1id, arf2id, p, change);</span>
					}

<span class="nc" id="L466">				}).build();</span>

<span class="nc" id="L468">		dest.addAll(oc.compare(ar1, ar2));</span>

<span class="nc" id="L470">		List&lt;String&gt; incompatibleChanges = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L472">		List&lt;Change&gt; changes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L473">		changes.add(new RepositoryTimestampChange());</span>

<span class="nc bnc" id="L475" title="All 2 branches missed.">		for (FileDelta d : dest)</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">			if (!changes.stream().anyMatch(c -&gt; c.accept(d)))</span>
<span class="nc" id="L477">				incompatibleChanges.add(render(d));</span>

<span class="nc bnc" id="L479" title="All 2 branches missed.">		for (Change c : changes)</span>
<span class="nc" id="L480">			c.check(incompatibleChanges::add);</span>

<span class="nc" id="L482">		incompatibleChanges.forEach(p -&gt; logger.info(&quot;Incompatible change: &quot; + p));</span>

<span class="nc" id="L484">		return incompatibleChanges.isEmpty();</span>
	}

	private boolean acceptableVersionChange(Version v1, Version v2) {
<span class="nc bnc" id="L488" title="All 2 branches missed.">		if (v1.getMajor() != v2.getMajor())</span>
<span class="nc" id="L489">			return false;</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">		if (v1.getMinor() != v2.getMinor())</span>
<span class="nc" id="L491">			return false;</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">		if (v1.getMicro() != v2.getMicro())</span>
<span class="nc" id="L493">			return false;</span>
<span class="nc bnc" id="L494" title="All 6 branches missed.">		return (v1.getQualifier() == null) == (v2.getQualifier() == null);</span>
	}

	private void compareArtifacts(ArtifactRepositoryFacade r1, FileId r1id, ArtifactFacade a1,
			ArtifactRepositoryFacade r2, FileId r2id, ArtifactFacade a2, List&lt;FileDelta&gt; dest, List&lt;Change&gt; changes)
			throws IOException {

<span class="nc" id="L501">		Path p1 = r1.getArtifactUri(a1.getId());</span>
<span class="nc" id="L502">		Path p2 = r2.getArtifactUri(a2.getId());</span>

<span class="nc" id="L504">		String classifier1 = a1.getClassifier();</span>
<span class="nc" id="L505">		String classifier2 = a2.getClassifier();</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">		if (!classifier1.equals(classifier2)) {</span>
<span class="nc" id="L507">			dest.add(new ArtifactClassifierDelta(r1id, r2id, a1.getId().getId(), render(a1), render(a2)));</span>
<span class="nc" id="L508">			return;</span>
		}

<span class="nc" id="L511">		FileId file1 = FileId.newRoot(p1);</span>
<span class="nc" id="L512">		FileId file2 = FileId.newRoot(p2);</span>

<span class="nc" id="L514">		FileComparator comparator = null;</span>
<span class="nc bnc" id="L515" title="All 14 branches missed.">		switch (classifier1) {</span>
		case &quot;osgi.bundle&quot;:
<span class="nc" id="L517">			comparator = comparators.get(BundleComparator.HINT);</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">			if (acceptableVersionChange(a1.getId().getVersion(), a2.getId().getVersion()))</span>
<span class="nc" id="L519">				changes.add(new BundleVersionChange(a1.getId().getId(), file1, a1.getId().getVersion(), file2,</span>
<span class="nc" id="L520">						a2.getId().getVersion()));</span>
			break;
		case &quot;org.eclipse.update.feature&quot;:
<span class="nc" id="L523">			comparator = comparators.get(FeatureComparator.HINT);</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">			if (acceptableVersionChange(a1.getId().getVersion(), a2.getId().getVersion()))</span>
<span class="nc" id="L525">				changes.add(new FeatureVersionChange(a1.getId().getId(), file1, a1.getId().getVersion(), file2,</span>
<span class="nc" id="L526">						a2.getId().getVersion()));</span>
			break;
		case &quot;binary&quot;:
<span class="nc" id="L529">			comparator = comparators.get(BinaryComparator.HINT);</span>
<span class="nc" id="L530">			break;</span>
		default:
<span class="nc" id="L532">			throw new Error(&quot;Unhandled artifact classifier &quot; + classifier1);</span>
		}

<span class="nc" id="L535">		comparator.compare(file1, p1, file2, p2, dest::add);</span>
<span class="nc" id="L536">	}</span>

	@SafeVarargs
	public final boolean run(P2Repository pr1, P2Repository pr2, Supplier&lt;Change&gt;... acceptedChanges)
			throws IOException {
<span class="nc" id="L541">		List&lt;FileDelta&gt; dest = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L543">		FileId root1 = FileId.newRoot(pr1.getPath());</span>
<span class="nc" id="L544">		FileId root2 = FileId.newRoot(pr2.getPath());</span>

<span class="nc" id="L546">		compare(root1, pr1.getArtifactDataCompressions(), root2, pr2.getArtifactDataCompressions(), P2Kind.artifact,</span>
				dest::add);
<span class="nc" id="L548">		compare(root1, pr1.getMetadataDataCompressions(), root2, pr2.getMetadataDataCompressions(), P2Kind.metadata,</span>
				dest::add);

<span class="nc" id="L551">		MetadataRepositoryFacade mdf1 = pr1.getMetadataRepositoryFacade();</span>
<span class="nc" id="L552">		FileId mdf1id = FileId.newRoot(mdf1.getPath());</span>
<span class="nc" id="L553">		MetadataRepositoryFacade mdf2 = pr2.getMetadataRepositoryFacade();</span>
<span class="nc" id="L554">		FileId mdf2id = FileId.newRoot(mdf2.getPath());</span>

<span class="nc" id="L556">		MetadataRepository md1 = mdf1.getRepository();</span>
<span class="nc" id="L557">		MetadataRepository md2 = mdf2.getRepository();</span>

<span class="nc" id="L559">		ArtifactRepositoryFacade r1 = pr1.getArtifactRepositoryFacade();</span>
<span class="nc" id="L560">		FileId r1id = FileId.newRoot(r1.getPath());</span>
<span class="nc" id="L561">		ArtifactRepositoryFacade r2 = pr2.getArtifactRepositoryFacade();</span>
<span class="nc" id="L562">		FileId r2id = FileId.newRoot(r2.getPath());</span>

<span class="nc" id="L564">		List&lt;Change&gt; changes = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L565">		changes.add(new RepositoryTimestampChange());</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">		for (Supplier&lt;Change&gt; a : acceptedChanges)</span>
<span class="nc" id="L567">			changes.add(a.get());</span>

<span class="nc" id="L569">		ObjectComparator&lt;FileDelta&gt; oc = createMetadataComparator().setDeltaCreator(new DeltaCreator&lt;FileDelta&gt;() {</span>

			@Override
			public FileDelta changed(OPath2 p, ChangeType change, Object m1, Object m2) {
<span class="nc bnc" id="L573" title="All 2 branches missed.">				if (p.size() &gt; 3) {</span>
<span class="nc" id="L574">					OPath2 unitPath = p.subPath(0, 3);</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">					if (unitPath.getPath().equals(&quot;//units/unit&quot;)) {</span>

<span class="nc" id="L577">						OPath2 rel = p.subPath(4);</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">						if (rel == null) {</span>
<span class="nc" id="L579">							return new MetadataDelta(mdf1id, mdf2id, p, change);</span>
						} else {
<span class="nc" id="L581">							Unit uleft = (Unit) p.subPath(3, 4).getLeft();</span>
<span class="nc" id="L582">							Unit uright = (Unit) p.subPath(3, 4).getRight();</span>

<span class="nc bnc" id="L584" title="All 10 branches missed.">							switch (rel.getPath()) {</span>
							case &quot;/provides/provided&quot;:
<span class="nc bnc" id="L586" title="All 3 branches missed.">								switch (change) {</span>
								case ADDED:
<span class="nc" id="L588">									return new ProvidedAdded(mdf1id, uleft, mdf2id, uright, (Provided) m2);</span>
								case REMOVED:
<span class="nc" id="L590">									return new ProvidedRemoved(mdf1id, uleft, mdf2id, uright, (Provided) m1);</span>
								default:
<span class="nc" id="L592">									throw new Error(change + &quot; &quot; + rel.getPath());</span>
								}
							case &quot;/requires/required&quot;:
<span class="nc bnc" id="L595" title="All 3 branches missed.">								switch (change) {</span>
								case ADDED:
<span class="nc" id="L597">									return new RequiredAdded(mdf1id, uleft, mdf2id, uright, (Required) m2);</span>
								case REMOVED:
<span class="nc" id="L599">									return new RequiredRemoved(mdf1id, uleft, mdf2id, uright, (Required) m1);</span>
								default:
<span class="nc" id="L601">									throw new Error(change + &quot; &quot; + rel.getPath());</span>
								}
							}

<span class="nc bnc" id="L605" title="All 2 branches missed.">							switch (change) {</span>
							case ADDED:
							case REMOVED:
							case CHANGED:
<span class="nc" id="L609">								return new UnitDelta(mdf1id, uleft, mdf2id, uright, rel);</span>
							default:
<span class="nc" id="L611">								throw new Error(change + &quot; &quot; + rel.getPath());</span>
							}

						}
					}
				}

<span class="nc bnc" id="L618" title="All 6 branches missed.">				switch (p.getPath()) {</span>
				case &quot;//properties/property[p2.timestamp]/value&quot;:
<span class="nc" id="L620">					return new RepositoryTimestampDelta(mdf1id, Long.parseLong((String) m1), mdf2id,</span>
<span class="nc" id="L621">							Long.parseLong((String) m2));</span>
				}

<span class="nc" id="L624">				return new MetadataDelta(mdf1id, mdf2id, p, change);</span>
			}

<span class="nc" id="L627">		}).build();</span>

<span class="nc" id="L629">		dest.addAll(oc.compare(md1, md2));</span>

		{
<span class="nc" id="L632">			Map&lt;ArtifactId, Unit&gt; c1 = getCategories(md1);</span>
<span class="nc" id="L633">			Map&lt;ArtifactId, Unit&gt; c2 = getCategories(md2);</span>
<span class="nc" id="L634">			Multimap&lt;String, ArtifactId&gt; id1 = HashMultimap.create();</span>
<span class="nc" id="L635">			Multimap&lt;String, ArtifactId&gt; id2 = HashMultimap.create();</span>

<span class="nc" id="L637">			c1.keySet().forEach(a -&gt; id1.put(a.getId(), a));</span>
<span class="nc" id="L638">			c2.keySet().forEach(a -&gt; id2.put(a.getId(), a));</span>

<span class="nc bnc" id="L640" title="All 2 branches missed.">			for (String a : Sets.union(id1.keySet(), id2.keySet())) {</span>
<span class="nc" id="L641">				Set&lt;ArtifactId&gt; i1 = new HashSet&lt;&gt;(id1.get(a));</span>
<span class="nc" id="L642">				Set&lt;ArtifactId&gt; i2 = new HashSet&lt;&gt;(id2.get(a));</span>

<span class="nc" id="L644">				Set&lt;ArtifactId&gt; intersection = new HashSet&lt;&gt;(i1);</span>
<span class="nc" id="L645">				intersection.retainAll(i2);</span>

<span class="nc bnc" id="L647" title="All 2 branches missed.">				for (ArtifactId id : intersection) {</span>
<span class="nc" id="L648">					i1.remove(id);</span>
<span class="nc" id="L649">					i2.remove(id);</span>
<span class="nc" id="L650">				}</span>

<span class="nc bnc" id="L652" title="All 4 branches missed.">				if (i1.size() == 1 &amp;&amp; i2.size() == 1) {</span>

<span class="nc" id="L654">					changes.add(new CategoryVersionChange(c1.get(Iterables.getOnlyElement(i1)),</span>
<span class="nc" id="L655">							c2.get(Iterables.getOnlyElement(i2))));</span>
				}
<span class="nc" id="L657">			}</span>

		}

<span class="nc" id="L661">		ObjectComparator&lt;FileDelta&gt; oc2 = createArtifactComparator().setDeltaCreator(new DeltaCreator&lt;FileDelta&gt;() {</span>

			@Override
			public FileDelta changed(OPath2 p, ChangeType change, Object m1, Object m2) {

<span class="nc bnc" id="L666" title="All 2 branches missed.">				if (p.size() &gt; 3) {</span>
<span class="nc" id="L667">					OPath2 unitPath = p.subPath(0, 3);</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">					if (unitPath.getPath().equals(&quot;//artifacts/artifact&quot;)) {</span>

<span class="nc" id="L670">						OPath2 rel = p.subPath(4);</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">						if (rel == null) {</span>
<span class="nc" id="L672">							return new ArtifactsDelta(r1id, r2id, p, change);</span>
						} else {
<span class="nc" id="L674">							Artifact uleft = (Artifact) p.subPath(3, 4).getLeft();</span>
<span class="nc" id="L675">							Artifact uright = (Artifact) p.subPath(3, 4).getRight();</span>

<span class="nc bnc" id="L677" title="All 2 branches missed.">							switch (change) {</span>
							case ADDED:
							case REMOVED:
							case CHANGED:
<span class="nc" id="L681">								return new ArtifactDelta(r1id, uleft, r2id, uright, rel);</span>
							default:
<span class="nc" id="L683">								throw new Error(change + &quot; &quot; + rel.getPath());</span>
							}

						}
					}
				}

<span class="nc bnc" id="L690" title="All 6 branches missed.">				switch (p.getPath()) {</span>
				case &quot;//properties/property[p2.timestamp]/value&quot;:
<span class="nc" id="L692">					return new RepositoryTimestampDelta(r1id, Long.parseLong((String) m1), r2id,</span>
<span class="nc" id="L693">							Long.parseLong((String) m2));</span>
				}

<span class="nc" id="L696">				return new ArtifactsDelta(r1id, r2id, p, change);</span>
			}

<span class="nc" id="L699">		}).build();</span>

<span class="nc" id="L701">		dest.addAll(oc2.compare(pr1.getArtifactRepositoryFacade().getRepository(),</span>
<span class="nc" id="L702">				pr2.getArtifactRepositoryFacade().getRepository()));</span>

<span class="nc" id="L704">		Multimap&lt;String, ArtifactId&gt; id1 = HashMultimap.create();</span>
<span class="nc" id="L705">		Multimap&lt;String, ArtifactId&gt; id2 = HashMultimap.create();</span>

<span class="nc" id="L707">		r1.getArtifacts().values().forEach(a -&gt; id1.put(a.getId().getId(), a.getId()));</span>
<span class="nc" id="L708">		r2.getArtifacts().values().forEach(a -&gt; id2.put(a.getId().getId(), a.getId()));</span>

<span class="nc bnc" id="L710" title="All 2 branches missed.">		for (String a : Sets.union(id1.keySet(), id2.keySet())) {</span>
<span class="nc" id="L711">			Set&lt;ArtifactId&gt; i1 = new HashSet&lt;&gt;(id1.get(a));</span>
<span class="nc" id="L712">			Set&lt;ArtifactId&gt; i2 = new HashSet&lt;&gt;(id2.get(a));</span>

<span class="nc" id="L714">			Set&lt;ArtifactId&gt; intersection = new HashSet&lt;&gt;(i1);</span>
<span class="nc" id="L715">			intersection.retainAll(i2);</span>

<span class="nc bnc" id="L717" title="All 2 branches missed.">			for (ArtifactId id : intersection) {</span>
<span class="nc" id="L718">				compareArtifacts(r1, r1id, r1.getArtifacts().get(id), r2, r2id, r2.getArtifacts().get(id), dest,</span>
						changes);

<span class="nc" id="L721">				i1.remove(id);</span>
<span class="nc" id="L722">				i2.remove(id);</span>
<span class="nc" id="L723">			}</span>

<span class="nc bnc" id="L725" title="All 4 branches missed.">			if (i1.size() == 1 &amp;&amp; i2.size() == 1) {</span>
<span class="nc" id="L726">				compareArtifacts(r1, r1id, r1.getArtifacts().get(Iterables.getOnlyElement(i1)), r2, r2id,</span>
<span class="nc" id="L727">						r2.getArtifacts().get(Iterables.getOnlyElement(i2)), dest, changes);</span>
			} else {
<span class="nc bnc" id="L729" title="All 2 branches missed.">				for (ArtifactId id : i1)</span>
<span class="nc" id="L730">					dest.add(new ArtifactRemovedDelta(r1id, r2id, render(r1.getArtifacts().get(id)), id));</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">				for (ArtifactId id : i2)</span>
<span class="nc" id="L732">					dest.add(new ArtifactAddedDelta(r1id, r2id, id, render(r2.getArtifacts().get(id))));</span>
			}
<span class="nc" id="L734">		}</span>

<span class="nc" id="L736">		List&lt;String&gt; incompatibleChanges = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L738" title="All 2 branches missed.">		for (FileDelta d : dest)</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">			if (!changes.stream().anyMatch(c -&gt; c.accept(d)))</span>
<span class="nc" id="L740">				incompatibleChanges.add(render(d));</span>

<span class="nc bnc" id="L742" title="All 2 branches missed.">		for (Change c : changes)</span>
<span class="nc" id="L743">			c.check(incompatibleChanges::add);</span>

<span class="nc" id="L745">		incompatibleChanges.forEach(p -&gt; logger.info(&quot;Incompatible change: &quot; + p));</span>

<span class="nc" id="L747">		return incompatibleChanges.isEmpty();</span>
	}

<span class="nc bnc" id="L750" title="All 2 branches missed.">	private static Predicate&lt;Unit&gt; isCategory = p -&gt; p.getProperties() != null</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">			&amp;&amp; p.getProperties().getProperty().stream().anyMatch(</span>
<span class="nc bnc" id="L752" title="All 4 branches missed.">					p1 -&gt; p1.getName().equals(&quot;org.eclipse.equinox.p2.type.category&quot;) &amp;&amp; p1.getValue().equals(&quot;true&quot;));</span>

	private static Map&lt;ArtifactId, Unit&gt; getCategories(MetadataRepository md1) {

<span class="nc bnc" id="L756" title="All 2 branches missed.">		if (md1.getUnits() == null)</span>
<span class="nc" id="L757">			return Collections.emptyMap();</span>

<span class="nc" id="L759">		return md1.getUnits().getUnit().stream().filter(isCategory)</span>
<span class="nc" id="L760">				.collect(Collectors.toMap(u -&gt; new ArtifactId(u.getId(), u.getVersion()), Function.identity()));</span>

	}

	private String render(FileDelta d1) {
<span class="nc" id="L765">		MessageFormat messageFormat = new MessageFormat(d1.getDescription());</span>

<span class="nc" id="L767">		Object[] o1 = d1.getParameters().clone();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">		for (int i = o1.length; i-- &gt; 0;)</span>
<span class="nc" id="L769">			o1[i] = render(o1[i]);</span>
<span class="nc" id="L770">		return d1.getBaselineFile() + &quot; -&gt; &quot; + d1.getCurrentFile() + &quot;: &quot; + messageFormat.format(o1);</span>
	}

<span class="nc" id="L773">	public static abstract class Change {</span>
		abstract boolean accept(FileDelta delta);

		abstract void check(Consumer&lt;String&gt; change);
	}

<span class="nc bnc" id="L779" title="All 2 branches missed.">	private static final Predicate&lt;SearchFilter&gt; featureFilter = p -&gt; p != null</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">			&amp;&amp; printer.print(p).equals(&quot;(org.eclipse.update.install.features=true)&quot;);</span>

	class CategoryVersionChange extends Change {
		final Unit left;
		final Unit right;

<span class="nc" id="L786">		public CategoryVersionChange(Unit left, Unit right) {</span>
<span class="nc" id="L787">			Preconditions.checkNotNull(left);</span>
<span class="nc" id="L788">			Preconditions.checkNotNull(right);</span>
<span class="nc" id="L789">			this.left = left;</span>
<span class="nc" id="L790">			this.right = right;</span>
<span class="nc" id="L791">		}</span>

		@Override
		boolean accept(FileDelta delta) {
<span class="nc bnc" id="L795" title="All 2 branches missed.">			if (!(delta instanceof AbstractUnitDelta))</span>
<span class="nc" id="L796">				return false;</span>

<span class="nc" id="L798">			AbstractUnitDelta d1 = (AbstractUnitDelta) delta;</span>
<span class="nc bnc" id="L799" title="All 4 branches missed.">			if (d1.left != left || d1.right != right)</span>
<span class="nc" id="L800">				return false;</span>

<span class="nc bnc" id="L802" title="All 2 branches missed.">			if (delta instanceof ProvidedRemoved) {</span>
<span class="nc" id="L803">				ProvidedRemoved d = (ProvidedRemoved) delta;</span>

<span class="nc bnc" id="L805" title="All 2 branches missed.">				if (isEqual(d.provided, &quot;org.eclipse.equinox.p2.iu&quot;, d.left.getId(), d.left.getVersion()))</span>
<span class="nc" id="L806">					return true;</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">			} else if (delta instanceof ProvidedAdded) {</span>
<span class="nc" id="L808">				ProvidedAdded d = (ProvidedAdded) delta;</span>

<span class="nc bnc" id="L810" title="All 2 branches missed.">				if (isEqual(d.provided, &quot;org.eclipse.equinox.p2.iu&quot;, d.right.getId(), d.right.getVersion()))</span>
<span class="nc" id="L811">					return true;</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">			} else if (delta instanceof UnitDelta) {</span>
<span class="nc" id="L813">				UnitDelta d = (UnitDelta) delta;</span>

<span class="nc bnc" id="L815" title="All 6 branches missed.">				switch (d.path.getPath()) {</span>
				case &quot;/version&quot;:
<span class="nc bnc" id="L817" title="All 2 branches missed.">					return d.path.getLeft().equals(d.left.getVersion())</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">							&amp;&amp; d.path.getRight().equals(d.right.getVersion());</span>
				default:
<span class="nc" id="L820">					return false;</span>
				}
			}

<span class="nc" id="L824">			return false;</span>
		}

		@Override
		void check(Consumer&lt;String&gt; change) {
<span class="nc" id="L829">		}</span>
	}

	static class FeatureVersionChange extends ArtifactVersionChange {
		private final String featureId;
		private final FileId file1;
		private final FileId file2;
		private final Version v1;
		private final Version v2;

<span class="nc" id="L839">		private Set&lt;Unit&gt; addedUnit = new HashSet&lt;&gt;();</span>
<span class="nc" id="L840">		private Set&lt;Unit&gt; removedUnit = new HashSet&lt;&gt;();</span>

		@Override
		void check(Consumer&lt;String&gt; incompatibleChanges) {
<span class="nc" id="L844">			super.check(incompatibleChanges);</span>

<span class="nc bnc" id="L846" title="All 2 branches missed.">			for (Unit u : Sets.union(addedUnit, removedUnit)) {</span>
<span class="nc" id="L847">				boolean a = addedUnit.contains(u);</span>
<span class="nc" id="L848">				boolean r = removedUnit.contains(u);</span>

<span class="nc bnc" id="L850" title="All 2 branches missed.">				if (!a)</span>
<span class="nc" id="L851">					incompatibleChanges.accept(&quot;Only removed: &quot; + u + &quot; &quot; + featureId);</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">				if (!r)</span>
<span class="nc" id="L853">					incompatibleChanges.accept(&quot;Only added: &quot; + u + &quot; &quot; + featureId);</span>
<span class="nc" id="L854">			}</span>

<span class="nc" id="L856">			return;</span>
		}

<span class="nc" id="L859">		public FeatureVersionChange(String featureId, FileId file1, Version v1, FileId file2, Version v2) {</span>
<span class="nc" id="L860">			Preconditions.checkNotNull(featureId);</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">			Preconditions.checkArgument(!featureId.isEmpty());</span>
<span class="nc" id="L862">			this.featureId = featureId;</span>
<span class="nc" id="L863">			Preconditions.checkNotNull(file1);</span>
<span class="nc" id="L864">			this.file1 = file1;</span>
<span class="nc" id="L865">			Preconditions.checkNotNull(v1);</span>
<span class="nc" id="L866">			this.v1 = v1;</span>
<span class="nc" id="L867">			Preconditions.checkNotNull(file2);</span>
<span class="nc" id="L868">			this.file2 = file2;</span>
<span class="nc" id="L869">			Preconditions.checkNotNull(v2);</span>
<span class="nc" id="L870">			this.v2 = v2;</span>
<span class="nc" id="L871">		}</span>

		@Override
		boolean accept(FileDelta delta) {
<span class="nc bnc" id="L875" title="All 2 branches missed.">			if (delta instanceof FeatureVersionDelta) {</span>
<span class="nc" id="L876">				FeatureVersionDelta d = (FeatureVersionDelta) delta;</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">				if (!d.getBaselineFile().getParent().equals(file1))</span>
<span class="nc" id="L878">					return false;</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">				if (!d.getCurrentFile().getParent().equals(file2))</span>
<span class="nc" id="L880">					return false;</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">				if (!Objects.equals(v1, d.getBaselineVersion()))</span>
<span class="nc" id="L882">					return false;</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">				if (!Objects.equals(v2, d.getCurrentVersion()))</span>
<span class="nc" id="L884">					return false;</span>
<span class="nc" id="L885">				return true;</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">			} else if (delta instanceof ProvidedAdded) {</span>
<span class="nc" id="L887">				ProvidedAdded d = (ProvidedAdded) delta;</span>

				// check unit is our right feature
<span class="nc bnc" id="L890" title="All 2 branches missed.">				if (hasOnlyArtifact(d.right, &quot;org.eclipse.update.feature&quot;, featureId, v2)) {</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">					if (isEqual(d.provided, &quot;org.eclipse.equinox.p2.iu&quot;, featureId + &quot;.feature.jar&quot;, v2))</span>
<span class="nc" id="L892">						return true;</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">					if (isEqual(d.provided, &quot;org.eclipse.update.feature&quot;, featureId, v2))</span>
<span class="nc" id="L894">						return true;</span>
				}

<span class="nc bnc" id="L897" title="All 2 branches missed.">				if (is(d.right, featureId + &quot;.feature.group&quot;, v2)) {</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">					if (isEqual(d.provided, &quot;org.eclipse.equinox.p2.iu&quot;, featureId + &quot;.feature.group&quot;, v2))</span>
<span class="nc" id="L899">						return true;</span>
				}

<span class="nc" id="L902">				return false;</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">			} else if (delta instanceof ProvidedRemoved) {</span>
<span class="nc" id="L904">				ProvidedRemoved d = (ProvidedRemoved) delta;</span>

				// check unit is our left feature
<span class="nc bnc" id="L907" title="All 2 branches missed.">				if (hasOnlyArtifact(d.left, &quot;org.eclipse.update.feature&quot;, featureId, v1)) {</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">					if (isEqual(d.provided, &quot;org.eclipse.equinox.p2.iu&quot;, featureId + &quot;.feature.jar&quot;, v1))</span>
<span class="nc" id="L909">						return true;</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">					if (isEqual(d.provided, &quot;org.eclipse.update.feature&quot;, featureId, v1))</span>
<span class="nc" id="L911">						return true;</span>
				}

<span class="nc bnc" id="L914" title="All 2 branches missed.">				if (is(d.left, featureId + &quot;.feature.group&quot;, v1)) {</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">					if (isEqual(d.provided, &quot;org.eclipse.equinox.p2.iu&quot;, featureId + &quot;.feature.group&quot;, v1))</span>
<span class="nc" id="L916">						return true;</span>
				}

<span class="nc" id="L919">				return false;</span>
<span class="nc bnc" id="L920" title="All 2 branches missed.">			} else if (delta instanceof RequiredAdded) {</span>
<span class="nc" id="L921">				RequiredAdded d = (RequiredAdded) delta;</span>

<span class="nc bnc" id="L923" title="All 2 branches missed.">				if (isFeatureGroup(d)) {</span>
<span class="nc" id="L924">					if (new RequiredMatcher() //</span>
<span class="nc" id="L925">							.withNamespace(&quot;org.eclipse.equinox.p2.iu&quot;::equals) //</span>
<span class="nc" id="L926">							.withName((featureId + &quot;.feature.jar&quot;)::equals) //</span>
<span class="nc" id="L927">							.withRange(new VersionRange(VersionRange.LEFT_CLOSED, v2, v2,</span>
									VersionRange.RIGHT_CLOSED)::equals) //
<span class="nc" id="L929">							.withFilter(featureFilter) //</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">							.test(d.required))</span>
<span class="nc" id="L931">						return true;</span>
				}

<span class="nc" id="L934">				if (new RequiredMatcher() //</span>
<span class="nc" id="L935">						.withNamespace(&quot;org.eclipse.equinox.p2.iu&quot;::equals) //</span>
<span class="nc" id="L936">						.withName((featureId + &quot;.feature.group&quot;)::equals) //</span>
<span class="nc" id="L937">						.withRange(</span>
								new VersionRange(VersionRange.LEFT_CLOSED, v2, v2, VersionRange.RIGHT_CLOSED)::equals) //
<span class="nc bnc" id="L939" title="All 2 branches missed.">						.test(d.required)) {</span>
<span class="nc" id="L940">					addedUnit.add(d.right);</span>
<span class="nc" id="L941">					return true;</span>
				}

<span class="nc" id="L944">				return false;</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">			} else if (delta instanceof RequiredRemoved) {</span>
<span class="nc" id="L946">				RequiredRemoved d = (RequiredRemoved) delta;</span>

<span class="nc bnc" id="L948" title="All 2 branches missed.">				if (isFeatureGroup(d)) {</span>
<span class="nc" id="L949">					if (new RequiredMatcher() //</span>
<span class="nc" id="L950">							.withNamespace(&quot;org.eclipse.equinox.p2.iu&quot;::equals) //</span>
<span class="nc" id="L951">							.withName((featureId + &quot;.feature.jar&quot;)::equals) //</span>
<span class="nc" id="L952">							.withRange(new VersionRange(VersionRange.LEFT_CLOSED, v1, v1,</span>
									VersionRange.RIGHT_CLOSED)::equals) //
<span class="nc" id="L954">							.withFilter(featureFilter) //</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">							.test(d.required))</span>
<span class="nc" id="L956">						return true;</span>
				}

<span class="nc" id="L959">				if (new RequiredMatcher().withNamespace(&quot;org.eclipse.equinox.p2.iu&quot;::equals) //</span>
<span class="nc" id="L960">						.withName((featureId + &quot;.feature.group&quot;)::equals) //</span>
<span class="nc" id="L961">						.withRange(</span>
								new VersionRange(VersionRange.LEFT_CLOSED, v1, v1, VersionRange.RIGHT_CLOSED)::equals) //
<span class="nc bnc" id="L963" title="All 2 branches missed.">						.test(d.required)) {</span>
<span class="nc" id="L964">					removedUnit.add(d.right);</span>
<span class="nc" id="L965">					return true;</span>
				}

<span class="nc" id="L968">				return false;</span>
<span class="nc bnc" id="L969" title="All 2 branches missed.">			} else if (delta instanceof ArtifactDelta) {</span>
<span class="nc" id="L970">				ArtifactDelta d = (ArtifactDelta) delta;</span>

<span class="nc bnc" id="L972" title="All 12 branches missed.">				switch (d.path.getPath()) {</span>
				case &quot;/properties/property[download.md5]/value&quot;:
				case &quot;/properties/property[artifact.size]/value&quot;:
				case &quot;/properties/property[download.size]/value&quot;:
<span class="nc" id="L976">					return true;</span>
				}

<span class="nc bnc" id="L979" title="All 2 branches missed.">				if (isFeatureJar(d)) {</span>
<span class="nc bnc" id="L980" title="All 6 branches missed.">					switch (d.path.getPath()) {</span>
					case &quot;/version&quot;:
<span class="nc bnc" id="L982" title="All 4 branches missed.">						if (d.path.getLeft().equals(v1) &amp;&amp; d.path.getRight().equals(v2)) {</span>
<span class="nc" id="L983">							removedArtifactsArtifacts.add(ArtifactKey.create(d.left));</span>
<span class="nc" id="L984">							addedArtifactsArtifacts.add(ArtifactKey.create(d.right));</span>
<span class="nc" id="L985">							return true;</span>
						}
					}
				}

<span class="nc" id="L990">				return false;</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">			} else if (delta instanceof UnitDelta) {</span>
<span class="nc" id="L992">				UnitDelta d = (UnitDelta) delta;</span>

<span class="nc bnc" id="L994" title="All 2 branches missed.">				if (isFeatureGroup(d)) {</span>

<span class="nc bnc" id="L996" title="All 10 branches missed.">					switch (d.path.getPath()) {</span>
					case &quot;/update/range&quot;:
<span class="nc" id="L998">						return d.path.getLeft()</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">								.equals(new VersionRange(VersionRange.LEFT_CLOSED, Version.emptyVersion, v1,</span>
										VersionRange.RIGHT_OPEN))
<span class="nc bnc" id="L1001" title="All 2 branches missed.">								&amp;&amp; d.path.getRight().equals(new VersionRange(VersionRange.LEFT_CLOSED,</span>
										Version.emptyVersion, v2, VersionRange.RIGHT_OPEN));
					case &quot;/version&quot;:
<span class="nc bnc" id="L1004" title="All 4 branches missed.">						return d.path.getLeft().equals(v1) &amp;&amp; d.path.getRight().equals(v2);</span>
					default:
<span class="nc" id="L1006">						return false;</span>
					}
<span class="nc bnc" id="L1008" title="All 2 branches missed.">				} else if (isFeatureJar(d)) {</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">					if (d.path.getPath().equals(&quot;/version&quot;))</span>
<span class="nc bnc" id="L1010" title="All 4 branches missed.">						return d.path.getLeft().equals(v1) &amp;&amp; d.path.getRight().equals(v2);</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">					else if (unitArtifactVersionMatcher.matches(d.path)) {</span>
<span class="nc" id="L1012">						MetadataArtifact l = (MetadataArtifact) d.path.getParent().getLeft();</span>
<span class="nc" id="L1013">						MetadataArtifact r = (MetadataArtifact) d.path.getParent().getRight();</span>

<span class="nc bnc" id="L1015" title="All 2 branches missed.">						if (!l.getClassifier().equals(&quot;org.eclipse.update.feature&quot;))</span>
<span class="nc" id="L1016">							return false;</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">						if (!l.getId().equals(featureId))</span>
<span class="nc" id="L1018">							return false;</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">						if (!l.getVersion().equals(v1))</span>
<span class="nc" id="L1020">							return false;</span>
<span class="nc bnc" id="L1021" title="All 2 branches missed.">						if (!r.getClassifier().equals(&quot;org.eclipse.update.feature&quot;))</span>
<span class="nc" id="L1022">							return false;</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">						if (!r.getId().equals(featureId))</span>
<span class="nc" id="L1024">							return false;</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">						if (!r.getVersion().equals(v2))</span>
<span class="nc" id="L1026">							return false;</span>

<span class="nc" id="L1028">						removedArtifactsMetadata.add(ArtifactKey.create(l));</span>
<span class="nc" id="L1029">						addedArtifactsMetadata.add(ArtifactKey.create(r));</span>
<span class="nc" id="L1030">						return true;</span>
					}
				}

<span class="nc" id="L1034">				return false;</span>
			} else {
<span class="nc" id="L1036">				return false;</span>
			}
		}

		boolean isFeatureJar(AbstractUnitDelta d) {
<span class="nc bnc" id="L1041" title="All 4 branches missed.">			return is(d.left, featureId + &quot;.feature.jar&quot;, v1) &amp;&amp; is(d.right, featureId + &quot;.feature.jar&quot;, v2);</span>
		}

		boolean isFeatureJar(ArtifactDelta d) {
<span class="nc bnc" id="L1045" title="All 2 branches missed.">			return d.left.getClassifier().equals(&quot;org.eclipse.update.feature&quot;)</span>
<span class="nc bnc" id="L1046" title="All 4 branches missed.">					&amp;&amp; d.right.getClassifier().equals(&quot;org.eclipse.update.feature&quot;) &amp;&amp; is(d.left, featureId, v1)</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">					&amp;&amp; is(d.right, featureId, v2);</span>
		}

		boolean isFeatureGroup(AbstractUnitDelta d) {
<span class="nc bnc" id="L1051" title="All 4 branches missed.">			return is(d.left, featureId + &quot;.feature.group&quot;, v1) &amp;&amp; is(d.right, featureId + &quot;.feature.group&quot;, v2);</span>
		}
	}

	static class ArtifactKey {
		@Override
		public int hashCode() {
<span class="nc" id="L1058">			final int prime = 31;</span>
<span class="nc" id="L1059">			int result = 1;</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">			result = prime * result + ((classifier == null) ? 0 : classifier.hashCode());</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">			result = prime * result + ((id == null) ? 0 : id.hashCode());</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">			result = prime * result + ((version == null) ? 0 : version.hashCode());</span>
<span class="nc" id="L1063">			return result;</span>
		}

		@Override
		public boolean equals(Object obj) {
<span class="nc bnc" id="L1068" title="All 2 branches missed.">			if (this == obj)</span>
<span class="nc" id="L1069">				return true;</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">			if (obj == null)</span>
<span class="nc" id="L1071">				return false;</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">			if (getClass() != obj.getClass())</span>
<span class="nc" id="L1073">				return false;</span>
<span class="nc" id="L1074">			ArtifactKey other = (ArtifactKey) obj;</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">			if (classifier == null) {</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">				if (other.classifier != null)</span>
<span class="nc" id="L1077">					return false;</span>
<span class="nc bnc" id="L1078" title="All 2 branches missed.">			} else if (!classifier.equals(other.classifier))</span>
<span class="nc" id="L1079">				return false;</span>
<span class="nc bnc" id="L1080" title="All 2 branches missed.">			if (id == null) {</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">				if (other.id != null)</span>
<span class="nc" id="L1082">					return false;</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">			} else if (!id.equals(other.id))</span>
<span class="nc" id="L1084">				return false;</span>
<span class="nc bnc" id="L1085" title="All 2 branches missed.">			if (version == null) {</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">				if (other.version != null)</span>
<span class="nc" id="L1087">					return false;</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">			} else if (!version.equals(other.version))</span>
<span class="nc" id="L1089">				return false;</span>
<span class="nc" id="L1090">			return true;</span>
		}

		private final String id;
		private final Version version;
		private final String classifier;

<span class="nc" id="L1097">		public ArtifactKey(String id, Version version, String classifier) {</span>
<span class="nc" id="L1098">			Preconditions.checkNotNull(id);</span>
<span class="nc" id="L1099">			Preconditions.checkNotNull(version);</span>
<span class="nc" id="L1100">			Preconditions.checkNotNull(classifier);</span>
<span class="nc" id="L1101">			this.id = id;</span>
<span class="nc" id="L1102">			this.version = version;</span>
<span class="nc" id="L1103">			this.classifier = classifier;</span>
<span class="nc" id="L1104">		}</span>

		public static ArtifactKey create(Artifact a) {
<span class="nc" id="L1107">			return new ArtifactKey(a.getId(), a.getVersion(), a.getClassifier());</span>
		}

		public static ArtifactKey create(MetadataArtifact r) {
<span class="nc" id="L1111">			return new ArtifactKey(r.getId(), r.getVersion(), r.getClassifier());</span>
		}

		@Override
		public String toString() {
<span class="nc" id="L1116">			return &quot;ArtifactKey(&quot; + id + &quot;,&quot; + version + &quot;,&quot; + classifier + &quot;)&quot;;</span>
		}

	}

<span class="nc" id="L1121">	final static private OPathMatcher unitArtifactVersionMatcher = OPathMatcher</span>
<span class="nc" id="L1122">			.create(&quot;/artifacts/artifact[*]/version&quot;);</span>

<span class="nc" id="L1124">	final static private OPathMatcher unitTouchpointInstructionValueMatcher = OPathMatcher</span>
<span class="nc" id="L1125">			.create(&quot;/touchpointData/instructions[*]/instruction[manifest]/value[Bundle-Version]&quot;);</span>

<span class="nc" id="L1127">	static class ProvidedMatcher implements Predicate&lt;Provided&gt; {</span>
<span class="nc bnc" id="L1128" title="All 2 branches missed.">		Predicate&lt;String&gt; name = p -&gt; p == null;</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">		Predicate&lt;String&gt; namespace = p -&gt; p == null;</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">		Predicate&lt;Version&gt; version = p -&gt; p == null;</span>

		@Override
		public boolean test(Provided t) {
<span class="nc bnc" id="L1134" title="All 2 branches missed.">			return name.test(t.getName()) //</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">					&amp;&amp; namespace.test(t.getNamespace()) //</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">					&amp;&amp; version.test(t.getVersion());</span>
		}

		public ProvidedMatcher withNamespace(Predicate&lt;String&gt; namespace) {
<span class="nc" id="L1140">			Preconditions.checkNotNull(namespace);</span>
<span class="nc" id="L1141">			this.namespace = namespace;</span>
<span class="nc" id="L1142">			return this;</span>
		}

		public ProvidedMatcher withName(Predicate&lt;String&gt; name) {
<span class="nc" id="L1146">			Preconditions.checkNotNull(name);</span>
<span class="nc" id="L1147">			this.name = name;</span>
<span class="nc" id="L1148">			return this;</span>
		}

		public ProvidedMatcher withVersion(Predicate&lt;Version&gt; version) {
<span class="nc" id="L1152">			Preconditions.checkNotNull(version);</span>
<span class="nc" id="L1153">			this.version = version;</span>
<span class="nc" id="L1154">			return this;</span>
		}
	}

<span class="nc" id="L1158">	static class RequiredMatcher implements Predicate&lt;Required&gt; {</span>

<span class="nc bnc" id="L1160" title="All 2 branches missed.">		Predicate&lt;SearchFilter&gt; filter = p -&gt; p == null;</span>
<span class="nc bnc" id="L1161" title="All 2 branches missed.">		Predicate&lt;String&gt; match = p -&gt; p == null;</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">		Predicate&lt;String&gt; matchParameters = p -&gt; p == null;</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">		Predicate&lt;Integer&gt; max = p -&gt; p == null;</span>
<span class="nc bnc" id="L1164" title="All 2 branches missed.">		Predicate&lt;Integer&gt; min = p -&gt; p == null;</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">		Predicate&lt;String&gt; name = p -&gt; p == null;</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">		Predicate&lt;String&gt; namespace = p -&gt; p == null;</span>
<span class="nc bnc" id="L1167" title="All 2 branches missed.">		Predicate&lt;VersionRange&gt; range = p -&gt; p == null;</span>

		@Override
		public boolean test(Required t) {
<span class="nc bnc" id="L1171" title="All 2 branches missed.">			return filter.test(t.getFilter()) //</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">					&amp;&amp; match.test(t.getMatch()) //</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">					&amp;&amp; matchParameters.test(t.getMatchParameters()) //</span>
<span class="nc bnc" id="L1174" title="All 4 branches missed.">					&amp;&amp; max.test(t.getMax()) &amp;&amp; min.test(t.getMin()) //</span>
<span class="nc bnc" id="L1175" title="All 2 branches missed.">					&amp;&amp; name.test(t.getName()) //</span>
<span class="nc bnc" id="L1176" title="All 2 branches missed.">					&amp;&amp; namespace.test(t.getNamespace()) //</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">					&amp;&amp; range.test(t.getRange());</span>
		}

		public RequiredMatcher withNamespace(Predicate&lt;String&gt; namespace) {
<span class="nc" id="L1181">			Preconditions.checkNotNull(namespace);</span>
<span class="nc" id="L1182">			this.namespace = namespace;</span>
<span class="nc" id="L1183">			return this;</span>
		}

		public RequiredMatcher withName(Predicate&lt;String&gt; name) {
<span class="nc" id="L1187">			Preconditions.checkNotNull(name);</span>
<span class="nc" id="L1188">			this.name = name;</span>
<span class="nc" id="L1189">			return this;</span>
		}

		public RequiredMatcher withRange(Predicate&lt;VersionRange&gt; range) {
<span class="nc" id="L1193">			Preconditions.checkNotNull(range);</span>
<span class="nc" id="L1194">			this.range = range;</span>
<span class="nc" id="L1195">			return this;</span>
		}

		public RequiredMatcher withFilter(Predicate&lt;SearchFilter&gt; filter) {
<span class="nc" id="L1199">			Preconditions.checkNotNull(range);</span>
<span class="nc" id="L1200">			this.filter = filter;</span>
<span class="nc" id="L1201">			return this;</span>
		}

	}

	static boolean is(Unit u, String id, Version version) {
<span class="nc bnc" id="L1207" title="All 4 branches missed.">		return u.getId().equals(id) &amp;&amp; u.getVersion().equals(version);</span>
	}

	static boolean is(Artifact u, String id, Version version) {
<span class="nc bnc" id="L1211" title="All 4 branches missed.">		return u.getId().equals(id) &amp;&amp; u.getVersion().equals(version);</span>
	}

	static boolean isEqual(Provided p, String namespace, String name, Version version) {
<span class="nc bnc" id="L1215" title="All 6 branches missed.">		return p.getNamespace().equals(namespace) &amp;&amp; p.getName().equals(name) &amp;&amp; p.getVersion().equals(version);</span>
	}

	static boolean hasOnlyArtifact(Unit u, String classifier, String id, Version version) {
<span class="nc bnc" id="L1219" title="All 4 branches missed.">		return u.getArtifacts() != null &amp;&amp; u.getArtifacts().getArtifact().size() == 1</span>
<span class="nc bnc" id="L1220" title="All 4 branches missed.">				&amp;&amp; u.getArtifacts().getArtifact().stream().allMatch(p -&gt; p.getClassifier().equals(classifier)</span>
<span class="nc bnc" id="L1221" title="All 4 branches missed.">						&amp;&amp; p.getId().equals(id) &amp;&amp; p.getVersion().equals(version));</span>
	}

<span class="nc" id="L1224">	static Version featureVersion = VersionParser.valueOf(&quot;1.0.0&quot;);</span>

	static boolean isFeature(Unit u) {
<span class="nc" id="L1227">		return u.getProvides().getProvided().stream()</span>
<span class="nc bnc" id="L1228" title="All 2 branches missed.">				.anyMatch(p -&gt; p.getNamespace().equals(&quot;org.eclipse.equinox.p2.eclipse.type&quot;) //</span>
<span class="nc bnc" id="L1229" title="All 2 branches missed.">						&amp;&amp; p.getName().equals(&quot;feature&quot;) //</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">						&amp;&amp; p.getVersion().equals(featureVersion));</span>

	}

	/**
	 * Common super class for metadata changes that imply version changes in
	 * associated artifacts.
	 * 
	 */
<span class="nc" id="L1239">	static abstract class ArtifactVersionChange extends Change {</span>

<span class="nc" id="L1241">		Set&lt;ArtifactKey&gt; removedArtifactsMetadata = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1242">		Set&lt;ArtifactKey&gt; addedArtifactsMetadata = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1243">		Set&lt;ArtifactKey&gt; removedArtifactsArtifacts = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1244">		Set&lt;ArtifactKey&gt; addedArtifactsArtifacts = new HashSet&lt;&gt;();</span>

		@Override
		void check(Consumer&lt;String&gt; incompatibleChanges) {
<span class="nc bnc" id="L1248" title="All 2 branches missed.">			for (ArtifactKey u : Sets.union(removedArtifactsArtifacts, removedArtifactsMetadata)) {</span>
<span class="nc" id="L1249">				boolean a = removedArtifactsArtifacts.contains(u);</span>
<span class="nc" id="L1250">				boolean m = removedArtifactsMetadata.contains(u);</span>

<span class="nc bnc" id="L1252" title="All 2 branches missed.">				if (!a)</span>
<span class="nc" id="L1253">					incompatibleChanges.accept(&quot;Only removed in metadata: &quot; + u);</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">				if (!m)</span>
<span class="nc" id="L1255">					incompatibleChanges.accept(&quot;Only removed in artifacts: &quot; + u);</span>
<span class="nc" id="L1256">			}</span>

<span class="nc bnc" id="L1258" title="All 2 branches missed.">			for (ArtifactKey u : Sets.union(addedArtifactsArtifacts, addedArtifactsMetadata)) {</span>
<span class="nc" id="L1259">				boolean a = addedArtifactsArtifacts.contains(u);</span>
<span class="nc" id="L1260">				boolean m = addedArtifactsMetadata.contains(u);</span>

<span class="nc bnc" id="L1262" title="All 2 branches missed.">				if (!a)</span>
<span class="nc" id="L1263">					incompatibleChanges.accept(&quot;Only added in metadata: &quot; + u);</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">				if (!m)</span>
<span class="nc" id="L1265">					incompatibleChanges.accept(&quot;Only added in artifacts: &quot; + u);</span>
<span class="nc" id="L1266">			}</span>
<span class="nc" id="L1267">		}</span>
	}

<span class="nc" id="L1270">	static class RepositoryTimestampChange extends Change {</span>

		@Override
		boolean accept(FileDelta delta) {
<span class="nc" id="L1274">			return delta instanceof RepositoryTimestampDelta;</span>
		}

		@Override
		void check(Consumer&lt;String&gt; change) {
<span class="nc" id="L1279">		}</span>

	}

<span class="nc" id="L1283">	static class BundleVersionChange extends ArtifactVersionChange {</span>
		private final String bundleId;
		private final FileId file1;
		private final FileId file2;
		private final Version v1;
		private final Version v2;

<span class="nc" id="L1290">		public BundleVersionChange(String bundleId, FileId file1, Version v1, FileId file2, Version v2) {</span>
<span class="nc" id="L1291">			Preconditions.checkNotNull(bundleId);</span>
<span class="nc bnc" id="L1292" title="All 2 branches missed.">			Preconditions.checkArgument(!bundleId.isEmpty());</span>
<span class="nc" id="L1293">			this.bundleId = bundleId;</span>
<span class="nc" id="L1294">			Preconditions.checkNotNull(file1);</span>
<span class="nc" id="L1295">			this.file1 = file1;</span>
<span class="nc" id="L1296">			Preconditions.checkNotNull(v1);</span>
<span class="nc" id="L1297">			this.v1 = v1;</span>
<span class="nc" id="L1298">			Preconditions.checkNotNull(file2);</span>
<span class="nc" id="L1299">			this.file2 = file2;</span>
<span class="nc" id="L1300">			Preconditions.checkNotNull(v2);</span>
<span class="nc" id="L1301">			this.v2 = v2;</span>
<span class="nc" id="L1302">		}</span>

<span class="nc" id="L1304">		private Set&lt;Unit&gt; addedUnit = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1305">		private Set&lt;Unit&gt; removedUnit = new HashSet&lt;&gt;();</span>

<span class="nc" id="L1307">		private Set&lt;String&gt; addedProvidedPackage = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1308">		private Set&lt;String&gt; removedProvidedPackage = new HashSet&lt;&gt;();</span>

		@Override
		void check(Consumer&lt;String&gt; incompatibleChanges) {
<span class="nc" id="L1312">			super.check(incompatibleChanges);</span>

<span class="nc bnc" id="L1314" title="All 2 branches missed.">			for (Unit u : Sets.union(addedUnit, removedUnit)) {</span>
<span class="nc" id="L1315">				boolean a = addedUnit.contains(u);</span>
<span class="nc" id="L1316">				boolean r = removedUnit.contains(u);</span>

<span class="nc bnc" id="L1318" title="All 2 branches missed.">				if (!a)</span>
<span class="nc" id="L1319">					incompatibleChanges.accept(&quot;Only removed: &quot; + u + &quot; &quot; + bundleId);</span>
<span class="nc bnc" id="L1320" title="All 2 branches missed.">				if (!r)</span>
<span class="nc" id="L1321">					incompatibleChanges.accept(&quot;Only added: &quot; + u + &quot; &quot; + bundleId);</span>
<span class="nc" id="L1322">			}</span>

<span class="nc bnc" id="L1324" title="All 2 branches missed.">			for (String u : Sets.union(addedProvidedPackage, removedProvidedPackage)) {</span>
<span class="nc" id="L1325">				boolean a = addedProvidedPackage.contains(u);</span>
<span class="nc" id="L1326">				boolean r = removedProvidedPackage.contains(u);</span>

<span class="nc bnc" id="L1328" title="All 2 branches missed.">				if (!a)</span>
<span class="nc" id="L1329">					incompatibleChanges.accept(&quot;Only removed package: &quot; + u + &quot; &quot; + bundleId);</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">				if (!r)</span>
<span class="nc" id="L1331">					incompatibleChanges.accept(&quot;Only added package: &quot; + u + &quot; &quot; + bundleId);</span>
<span class="nc" id="L1332">			}</span>

<span class="nc" id="L1334">			return;</span>
		}

		@Override
		boolean accept(FileDelta delta) {
<span class="nc bnc" id="L1339" title="All 2 branches missed.">			if (delta instanceof ManifestVersionDelta) {</span>
<span class="nc" id="L1340">				ManifestVersionDelta d = (ManifestVersionDelta) delta;</span>
<span class="nc bnc" id="L1341" title="All 2 branches missed.">				if (!d.getBaselineFile().getParent().equals(file1))</span>
<span class="nc" id="L1342">					return false;</span>
<span class="nc bnc" id="L1343" title="All 2 branches missed.">				if (!d.getCurrentFile().getParent().equals(file2))</span>
<span class="nc" id="L1344">					return false;</span>
<span class="nc bnc" id="L1345" title="All 2 branches missed.">				if (!Objects.equals(v1, d.getBaselineVersion()))</span>
<span class="nc" id="L1346">					return false;</span>
<span class="nc bnc" id="L1347" title="All 2 branches missed.">				if (!Objects.equals(v2, d.getCurrentVersion()))</span>
<span class="nc" id="L1348">					return false;</span>
<span class="nc" id="L1349">				return true;</span>
<span class="nc bnc" id="L1350" title="All 2 branches missed.">			} else if (delta instanceof ManifestExportPackageVersionDelta) {</span>
<span class="nc" id="L1351">				ManifestExportPackageVersionDelta d = (ManifestExportPackageVersionDelta) delta;</span>

<span class="nc bnc" id="L1353" title="All 2 branches missed.">				if (!Objects.equals(v1, d.getBaselineVersion()))</span>
<span class="nc" id="L1354">					return false;</span>
<span class="nc bnc" id="L1355" title="All 2 branches missed.">				if (!Objects.equals(v2, d.getCurrentVersion()))</span>
<span class="nc" id="L1356">					return false;</span>
<span class="nc" id="L1357">				return true;</span>

<span class="nc bnc" id="L1359" title="All 2 branches missed.">			} else if (delta instanceof ManifestEclipseSourceBundleVersionDelta) {</span>
<span class="nc" id="L1360">				ManifestEclipseSourceBundleVersionDelta d = (ManifestEclipseSourceBundleVersionDelta) delta;</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">				if (!bundleId.equals(d.getBundleId()))</span>
<span class="nc" id="L1362">					return false;</span>
<span class="nc bnc" id="L1363" title="All 2 branches missed.">				if (!Objects.equals(v1, d.getBaselineVersion()))</span>
<span class="nc" id="L1364">					return false;</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">				if (!Objects.equals(v2, d.getCurrentVersion()))</span>
<span class="nc" id="L1366">					return false;</span>
<span class="nc" id="L1367">				return true;</span>
<span class="nc bnc" id="L1368" title="All 2 branches missed.">			} else if (delta instanceof ManifestHeaderDelta) {</span>
<span class="nc" id="L1369">				ManifestHeaderDelta d = (ManifestHeaderDelta) delta;</span>
<span class="nc bnc" id="L1370" title="All 2 branches missed.">				if (!d.getBaselineFile().getParent().equals(file1))</span>
<span class="nc" id="L1371">					return false;</span>
<span class="nc bnc" id="L1372" title="All 2 branches missed.">				if (!d.getCurrentFile().getParent().equals(file2))</span>
<span class="nc" id="L1373">					return false;</span>
<span class="nc bnc" id="L1374" title="All 2 branches missed.">				if (!d.getKey().equals(&quot;Bnd-LastModified&quot;))</span>
<span class="nc" id="L1375">					return false;</span>

<span class="nc" id="L1377">				return true;</span>
<span class="nc bnc" id="L1378" title="All 2 branches missed.">			} else if (delta instanceof FeaturePluginVersionDelta) {</span>
<span class="nc" id="L1379">				FeaturePluginVersionDelta d = (FeaturePluginVersionDelta) delta;</span>
<span class="nc bnc" id="L1380" title="All 2 branches missed.">				if (!d.getPluginId().equals(bundleId))</span>
<span class="nc" id="L1381">					return false;</span>
<span class="nc bnc" id="L1382" title="All 2 branches missed.">				if (!Objects.equals(v1, d.getBaselineVersion()))</span>
<span class="nc" id="L1383">					return false;</span>
<span class="nc bnc" id="L1384" title="All 2 branches missed.">				if (!Objects.equals(v2, d.getCurrentVersion()))</span>
<span class="nc" id="L1385">					return false;</span>
<span class="nc" id="L1386">				return true;</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">			} else if (delta instanceof ProvidedAdded) {</span>
<span class="nc" id="L1388">				ProvidedAdded d = (ProvidedAdded) delta;</span>

<span class="nc bnc" id="L1390" title="All 2 branches missed.">				if (!isBundle(d))</span>
<span class="nc" id="L1391">					return false;</span>

<span class="nc bnc" id="L1393" title="All 2 branches missed.">				if (isEqual(d.provided, &quot;org.eclipse.equinox.p2.iu&quot;, bundleId, v2))</span>
<span class="nc" id="L1394">					return true;</span>

<span class="nc bnc" id="L1396" title="All 2 branches missed.">				if (isEqual(d.provided, &quot;osgi.bundle&quot;, bundleId, v2))</span>
<span class="nc" id="L1397">					return true;</span>

<span class="nc" id="L1399">				if (new ProvidedMatcher().withNamespace(&quot;java.package&quot;::equals) //</span>
<span class="nc" id="L1400">						.withName(p -&gt; true) //</span>
<span class="nc" id="L1401">						.withVersion(v2::equals) //</span>
<span class="nc bnc" id="L1402" title="All 2 branches missed.">						.test(d.provided)) {</span>
<span class="nc" id="L1403">					addedProvidedPackage.add(d.provided.getName());</span>
<span class="nc" id="L1404">					return true;</span>
				}

<span class="nc" id="L1407">				return false;</span>
<span class="nc bnc" id="L1408" title="All 2 branches missed.">			} else if (delta instanceof ProvidedRemoved) {</span>
<span class="nc" id="L1409">				ProvidedRemoved d = (ProvidedRemoved) delta;</span>

<span class="nc bnc" id="L1411" title="All 2 branches missed.">				if (!isBundle(d))</span>
<span class="nc" id="L1412">					return false;</span>

<span class="nc bnc" id="L1414" title="All 2 branches missed.">				if (isEqual(d.provided, &quot;org.eclipse.equinox.p2.iu&quot;, bundleId, v1))</span>
<span class="nc" id="L1415">					return true;</span>

<span class="nc bnc" id="L1417" title="All 2 branches missed.">				if (isEqual(d.provided, &quot;osgi.bundle&quot;, bundleId, v1))</span>
<span class="nc" id="L1418">					return true;</span>

<span class="nc" id="L1420">				if (new ProvidedMatcher().withNamespace(&quot;java.package&quot;::equals) //</span>
<span class="nc" id="L1421">						.withName(p -&gt; true) //</span>
<span class="nc" id="L1422">						.withVersion(v1::equals) //</span>
<span class="nc bnc" id="L1423" title="All 2 branches missed.">						.test(d.provided)) {</span>
<span class="nc" id="L1424">					removedProvidedPackage.add(d.provided.getName());</span>
<span class="nc" id="L1425">					return true;</span>
				}

<span class="nc" id="L1428">				return false;</span>
<span class="nc bnc" id="L1429" title="All 2 branches missed.">			} else if (delta instanceof RequiredAdded) {</span>
<span class="nc" id="L1430">				RequiredAdded d = (RequiredAdded) delta;</span>

<span class="nc" id="L1432">				if (new RequiredMatcher().//</span>
<span class="nc" id="L1433">						withNamespace(&quot;org.eclipse.equinox.p2.iu&quot;::equals) //</span>
<span class="nc" id="L1434">						.withName(bundleId::equals) //</span>
<span class="nc" id="L1435">						.withRange(</span>
								new VersionRange(VersionRange.LEFT_CLOSED, v2, v2, VersionRange.RIGHT_CLOSED)::equals) //
<span class="nc bnc" id="L1437" title="All 2 branches missed.">						.test(d.required)) {</span>
<span class="nc" id="L1438">					addedUnit.add(d.right);</span>
<span class="nc" id="L1439">					return true;</span>
				}

<span class="nc" id="L1442">				return false;</span>
<span class="nc bnc" id="L1443" title="All 2 branches missed.">			} else if (delta instanceof RequiredRemoved) {</span>
<span class="nc" id="L1444">				RequiredRemoved d = (RequiredRemoved) delta;</span>

<span class="nc" id="L1446">				if (new RequiredMatcher() //</span>
<span class="nc" id="L1447">						.withNamespace(&quot;org.eclipse.equinox.p2.iu&quot;::equals) //</span>
<span class="nc" id="L1448">						.withName(bundleId::equals) //</span>
<span class="nc" id="L1449">						.withRange(</span>
								new VersionRange(VersionRange.LEFT_CLOSED, v1, v1, VersionRange.RIGHT_CLOSED)::equals) //
<span class="nc bnc" id="L1451" title="All 2 branches missed.">						.test(d.required)) {</span>
<span class="nc" id="L1452">					removedUnit.add(d.right);</span>
<span class="nc" id="L1453">					return true;</span>
				}

<span class="nc" id="L1456">				return false;</span>
<span class="nc bnc" id="L1457" title="All 2 branches missed.">			} else if (delta instanceof ArtifactDelta) {</span>
<span class="nc" id="L1458">				ArtifactDelta d = (ArtifactDelta) delta;</span>

<span class="nc bnc" id="L1460" title="All 12 branches missed.">				switch (d.path.getPath()) {</span>
				case &quot;/properties/property[download.md5]/value&quot;:
				case &quot;/properties/property[artifact.size]/value&quot;:
				case &quot;/properties/property[download.size]/value&quot;:
<span class="nc" id="L1464">					return true;</span>
				}

<span class="nc bnc" id="L1467" title="All 2 branches missed.">				if (isBundle(d)) {</span>
<span class="nc bnc" id="L1468" title="All 6 branches missed.">					switch (d.path.getPath()) {</span>
					case &quot;/version&quot;:
<span class="nc bnc" id="L1470" title="All 4 branches missed.">						if (d.path.getLeft().equals(v1) &amp;&amp; d.path.getRight().equals(v2)) {</span>
<span class="nc" id="L1471">							removedArtifactsArtifacts.add(ArtifactKey.create(d.left));</span>
<span class="nc" id="L1472">							addedArtifactsArtifacts.add(ArtifactKey.create(d.right));</span>
<span class="nc" id="L1473">							return true;</span>
						}
					}
				}

<span class="nc" id="L1478">				return false;</span>
<span class="nc bnc" id="L1479" title="All 2 branches missed.">			} else if (delta instanceof UnitDelta) {</span>
<span class="nc" id="L1480">				UnitDelta d = (UnitDelta) delta;</span>

<span class="nc bnc" id="L1482" title="All 2 branches missed.">				if (!isBundle(d))</span>
<span class="nc" id="L1483">					return false;</span>

<span class="nc bnc" id="L1485" title="All 2 branches missed.">				if (d.path.getPath().equals(&quot;/version&quot;)) {</span>
<span class="nc bnc" id="L1486" title="All 2 branches missed.">					if (!d.path.getLeft().equals(v1))</span>
<span class="nc" id="L1487">						return false;</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">					if (!d.path.getRight().equals(v2))</span>
<span class="nc" id="L1489">						return false;</span>
<span class="nc" id="L1490">					return true;</span>
				}

<span class="nc bnc" id="L1493" title="All 2 branches missed.">				if (d.path.getPath().equals(&quot;/update/range&quot;)) {</span>
<span class="nc" id="L1494">					return d.path.getLeft()</span>
<span class="nc bnc" id="L1495" title="All 2 branches missed.">							.equals(new VersionRange(VersionRange.LEFT_CLOSED, Version.emptyVersion, v1,</span>
									VersionRange.RIGHT_OPEN))
<span class="nc bnc" id="L1497" title="All 2 branches missed.">							&amp;&amp; d.path.getRight().equals(new VersionRange(VersionRange.LEFT_CLOSED, Version.emptyVersion,</span>
									v2, VersionRange.RIGHT_OPEN));
<span class="nc bnc" id="L1499" title="All 2 branches missed.">				} else if (unitArtifactVersionMatcher.matches(d.path)) {</span>
<span class="nc" id="L1500">					MetadataArtifact l = (MetadataArtifact) d.path.getParent().getLeft();</span>
<span class="nc" id="L1501">					MetadataArtifact r = (MetadataArtifact) d.path.getParent().getRight();</span>

<span class="nc bnc" id="L1503" title="All 2 branches missed.">					if (!l.getClassifier().equals(&quot;osgi.bundle&quot;))</span>
<span class="nc" id="L1504">						return false;</span>
<span class="nc bnc" id="L1505" title="All 2 branches missed.">					if (!l.getId().equals(bundleId))</span>
<span class="nc" id="L1506">						return false;</span>
<span class="nc bnc" id="L1507" title="All 2 branches missed.">					if (!l.getVersion().equals(v1))</span>
<span class="nc" id="L1508">						return false;</span>
<span class="nc bnc" id="L1509" title="All 2 branches missed.">					if (!r.getClassifier().equals(&quot;osgi.bundle&quot;))</span>
<span class="nc" id="L1510">						return false;</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">					if (!r.getId().equals(bundleId))</span>
<span class="nc" id="L1512">						return false;</span>
<span class="nc bnc" id="L1513" title="All 2 branches missed.">					if (!r.getVersion().equals(v2))</span>
<span class="nc" id="L1514">						return false;</span>

<span class="nc" id="L1516">					removedArtifactsMetadata.add(ArtifactKey.create(l));</span>
<span class="nc" id="L1517">					addedArtifactsMetadata.add(ArtifactKey.create(r));</span>

<span class="nc" id="L1519">					return true;</span>
<span class="nc bnc" id="L1520" title="All 2 branches missed.">				} else if (unitTouchpointInstructionValueMatcher.matches(d.path)) {</span>
					// Instruction l = (Instruction)
					// d.path.getParent().getParent().getLeft();
					// Instruction r = (Instruction)
					// d.path.getParent().getParent().getRight();

<span class="nc" id="L1526">					Version vl = VersionParser.valueOf((String) d.path.getLeft());</span>
<span class="nc" id="L1527">					Version vr = VersionParser.valueOf((String) d.path.getRight());</span>

<span class="nc bnc" id="L1529" title="All 2 branches missed.">					if (!v1.equals(vl))</span>
<span class="nc" id="L1530">						return false;</span>
<span class="nc bnc" id="L1531" title="All 2 branches missed.">					if (!v2.equals(vr))</span>
<span class="nc" id="L1532">						return false;</span>

<span class="nc" id="L1534">					return true;</span>
				}
			}
<span class="nc" id="L1537">			return false;</span>
		}

		boolean isBundle(AbstractUnitDelta d) {
<span class="nc bnc" id="L1541" title="All 4 branches missed.">			return is(d.left, bundleId, v1) &amp;&amp; is(d.right, bundleId, v2);</span>
		}

		boolean isBundle(ArtifactDelta d) {
<span class="nc bnc" id="L1545" title="All 4 branches missed.">			return is(d.left, bundleId, v1) &amp;&amp; is(d.right, bundleId, v2);</span>
		}

	}

	private String render(Object o) {
<span class="nc bnc" id="L1551" title="All 2 branches missed.">		if (o instanceof List) {</span>
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L1553">			List&lt;Object&gt; l = (List&lt;Object&gt;) (List&lt;?&gt;) o;</span>
<span class="nc" id="L1554">			return &quot;[&quot; + l.stream().map(this::render).collect(Collectors.joining(&quot;, &quot;)) + &quot;]&quot;;</span>
		}

<span class="nc bnc" id="L1557" title="All 2 branches missed.">		if (o instanceof Child) {</span>
<span class="nc" id="L1558">			return new DomRenderer().jaxbRender(CompositeRepositoryFactory.getJaxbContext(), o,</span>
					DomRenderer.Options.TOP_LEVEL);
		}

<span class="nc bnc" id="L1562" title="All 6 branches missed.">		if (o instanceof Required || o instanceof Provided || o instanceof Unit) {</span>
<span class="nc" id="L1563">			return new DomRenderer().jaxbRender(MetadataRepositoryFactory.getJaxbContext(), o,</span>
					DomRenderer.Options.TOP_LEVEL);
		}

<span class="nc bnc" id="L1567" title="All 2 branches missed.">		if (o instanceof ArtifactFacade) {</span>
<span class="nc" id="L1568">			o = ((ArtifactFacade) o).getData();</span>
		}

<span class="nc bnc" id="L1571" title="All 2 branches missed.">		if (o instanceof Artifact) {</span>
<span class="nc" id="L1572">			return new DomRenderer().jaxbRender(ArtifactRepositoryFactory.getJaxbContext(), o,</span>
					DomRenderer.Options.TOP_LEVEL);
		}

<span class="nc bnc" id="L1576" title="All 2 branches missed.">		if (o instanceof MetadataArtifact) {</span>
<span class="nc" id="L1577">			return new DomRenderer().jaxbRender(MetadataRepositoryFactory.getJaxbContext(), o, &quot;artifact&quot;,</span>
					DomRenderer.Options.TOP_LEVEL);
		}

<span class="nc" id="L1581">		return String.valueOf(o);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>