<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DeploymentHelper.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">tppt-maven-plugin</a> &gt; <a href="../index.html" class="el_bundle">tppt-core</a> &gt; <a href="index.source.html" class="el_package">com.github.pms1.tppt.core</a> &gt; <span class="el_source">DeploymentHelper.java</span></div><h1>DeploymentHelper.java</h1><pre class="source lang-java linenums">package com.github.pms1.tppt.core;

import java.io.File;
import java.io.IOException;
import java.nio.file.DirectoryNotEmptyException;
import java.nio.file.FileSystem;
import java.nio.file.FileSystems;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeFormatterBuilder;
import java.time.temporal.ChronoField;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeSet;
import java.util.function.Function;
import java.util.regex.Pattern;

import org.apache.maven.model.Plugin;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.project.MavenProject;
import org.codehaus.plexus.component.annotations.Component;
import org.codehaus.plexus.component.annotations.Requirement;
import org.codehaus.plexus.util.xml.Xpp3Dom;

import com.github.pms1.tppt.core.InterpolatedString.Visitor;
import com.github.pms1.tppt.p2.ArtifactId;
import com.github.pms1.tppt.p2.ArtifactRepositoryFacade;
import com.github.pms1.tppt.p2.CommonP2Repository;
import com.github.pms1.tppt.p2.DataCompression;
import com.github.pms1.tppt.p2.P2CompositeRepository;
import com.github.pms1.tppt.p2.P2Repository;
import com.github.pms1.tppt.p2.P2RepositoryFactory;
import com.github.pms1.tppt.p2.P2RepositoryFactory.P2IndexType;
import com.github.pms1.tppt.p2.P2RepositoryVisitor;
import com.github.pms1.tppt.p2.PathByteSource;
import com.github.pms1.tppt.p2.RepositoryFacade;
import com.google.common.base.Joiner;
import com.google.common.base.Preconditions;
import com.google.common.collect.Sets;
import com.google.common.io.ByteSource;

@Component(role = DeploymentHelper.class)
<span class="nc" id="L51">public class DeploymentHelper {</span>
	@Requirement
	private P2RepositoryFactory factory;

	private LocalDateTime extractP2Timestamp(Path root) throws IOException {
<span class="nc" id="L56">		try (FileSystem fs = FileSystems.newFileSystem(root, null)) {</span>

<span class="nc" id="L58">			CommonP2Repository repo = factory.loadAny(fs.getPath(&quot;/&quot;));</span>

<span class="nc" id="L60">			RepositoryFacade&lt;?&gt; artifactRepositoryFacade = repo.getArtifactRepositoryFacade();</span>

<span class="nc" id="L62">			long ts_ms = artifactRepositoryFacade.getTimestamp();</span>

<span class="nc" id="L64">			return LocalDateTime.ofEpochSecond(ts_ms / 1000, (int) (ts_ms % 1000) * 1000000, ZoneOffset.UTC);</span>
<span class="nc bnc" id="L65" title="All 8 branches missed.">		}</span>
	}

	private String getLayout(MavenProject p) {
<span class="nc" id="L69">		Plugin plugin = p.getPlugin(&quot;com.github.pms1.tppt:tppt-maven-plugin&quot;);</span>

<span class="nc" id="L71">		Xpp3Dom configuration = (Xpp3Dom) plugin.getConfiguration();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">		Xpp3Dom layout = configuration != null ? configuration.getChild(&quot;layout&quot;) : null;</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">		if (layout == null)</span>
<span class="nc" id="L74">			return &quot;@{artifactId}-@{version}-@{timestamp}&quot;;</span>
		else
<span class="nc" id="L76">			return layout.getValue();</span>
	}

	public Path getPath(MavenProject p) throws MojoExecutionException {
		try {
<span class="nc" id="L81">			return getPath(p, extractP2Timestamp(p.getArtifact().getFile().toPath()));</span>
<span class="nc" id="L82">		} catch (IOException e1) {</span>
<span class="nc" id="L83">			throw new MojoExecutionException(&quot;foo&quot;, e1);</span>
		}
	}

	public Path getPath(MavenProject p, LocalDateTime timestamp) throws MojoExecutionException {
<span class="nc" id="L88">		Preconditions.checkNotNull(p);</span>

<span class="nc" id="L90">		String layout = getLayout(p);</span>
<span class="nc" id="L91">		InterpolatedString layout1 = InterpolatedString.parse(layout);</span>
<span class="nc" id="L92">		Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();</span>
<span class="nc" id="L93">		context.put(&quot;group&quot;, p.getGroupId());</span>
<span class="nc" id="L94">		context.put(&quot;artifactId&quot;, p.getArtifactId());</span>
<span class="nc" id="L95">		context.put(&quot;version&quot;, p.getVersion());</span>
<span class="nc" id="L96">		context.put(&quot;timestamp&quot;, timestamp);</span>

<span class="nc" id="L98">		return Paths.get(interpolate(layout1, context));</span>
	}

	public RepositoryPathPattern getPathPattern(MavenProject p) {
<span class="nc" id="L102">		Preconditions.checkNotNull(p);</span>

<span class="nc" id="L104">		String layout = getLayout(p);</span>
<span class="nc" id="L105">		InterpolatedString layout1 = InterpolatedString.parse(layout);</span>
<span class="nc" id="L106">		Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();</span>
<span class="nc" id="L107">		context.put(&quot;group&quot;, p.getGroupId());</span>
<span class="nc" id="L108">		context.put(&quot;artifactId&quot;, p.getArtifactId());</span>
<span class="nc" id="L109">		context.put(&quot;version&quot;, p.getVersion());</span>
<span class="nc" id="L110">		context.put(&quot;timestamp&quot;, LocalDateTime.class);</span>

<span class="nc" id="L112">		return interpolatePattern(layout1, context);</span>
	}

	private String interpolate(InterpolatedString layout1, Map&lt;String, Object&gt; context) {
<span class="nc" id="L116">		StringBuilder b = new StringBuilder();</span>

<span class="nc" id="L118">		layout1.accept(new Visitor() {</span>

			@Override
			public void visitText(String text) {
<span class="nc" id="L122">				b.append(text);</span>
<span class="nc" id="L123">			}</span>

			@Override
			public void visitVariable(List&lt;String&gt; variable) {
<span class="nc" id="L127">				Object o = context.get(variable.get(0));</span>
				String s;
<span class="nc bnc" id="L129" title="All 2 branches missed.">				if (o == null) {</span>
<span class="nc" id="L130">					throw new IllegalArgumentException(&quot;No variable: &quot; + variable.get(0));</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">				} else if (o.getClass() == String.class) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">					if (variable.size() != 1)</span>
<span class="nc" id="L133">						throw new IllegalArgumentException();</span>
<span class="nc" id="L134">					s = o.toString();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">				} else if (o.getClass() == LocalDateTime.class) {</span>
					DateTimeFormatter formatter;
<span class="nc bnc" id="L137" title="All 2 branches missed.">					if (variable.size() == 1)</span>
<span class="nc" id="L138">						formatter = defaultFormatter;</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">					else if (variable.size() == 2)</span>
<span class="nc" id="L140">						formatter = DateTimeFormatter.ofPattern(variable.get(1));</span>
					else
<span class="nc" id="L142">						throw new IllegalArgumentException();</span>
<span class="nc" id="L143">					s = formatter.format((LocalDateTime) o);</span>
<span class="nc" id="L144">				} else {</span>
<span class="nc" id="L145">					throw new IllegalArgumentException();</span>
				}
<span class="nc" id="L147">				b.append(s);</span>
<span class="nc" id="L148">			}</span>

		});

<span class="nc" id="L152">		return b.toString();</span>
	}

<span class="nc" id="L155">	static private final Joiner pathJoiner = Joiner.on(&quot;/&quot;);</span>

	// should be: &lt;code&gt;DateTimeFormatter.ofPattern(&quot;yyyyMMddHHmmssSSS&quot;)&lt;/code&gt;
	// but see https://bugs.openjdk.java.net/browse/JDK-8031085
<span class="nc" id="L159">	static private final DateTimeFormatter defaultFormatter = new DateTimeFormatterBuilder()</span>
<span class="nc" id="L160">			.appendPattern(&quot;yyyyMMddHHmmss&quot;).appendValue(ChronoField.MILLI_OF_SECOND, 3).toFormatter();</span>

	static private final String defaultFormatterRegexp = &quot;\\d{17}&quot;;

	private RepositoryPathPattern interpolatePattern(InterpolatedString layout1, Map&lt;String, Object&gt; context) {
<span class="nc" id="L165">		StringBuilder b = new StringBuilder();</span>

<span class="nc" id="L167">		Map&lt;String, Function&lt;String, Object&gt;&gt; postProcessors = new HashMap&lt;&gt;();</span>

<span class="nc" id="L169">		layout1.accept(new Visitor() {</span>

			@Override
			public void visitText(String text) {
<span class="nc" id="L173">				b.append(Pattern.quote(text));</span>
<span class="nc" id="L174">			}</span>

			@Override
			public void visitVariable(List&lt;String&gt; variable) {
<span class="nc" id="L178">				Object o = context.get(variable.get(0));</span>

<span class="nc bnc" id="L180" title="All 2 branches missed.">				if (o == null) {</span>
<span class="nc" id="L181">					throw new IllegalArgumentException(&quot;No variable: &quot; + variable.get(0));</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">				} else if (o.getClass() == String.class) {</span>
<span class="nc" id="L183">					b.append(Pattern.quote((String) o));</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">				} else if (o == LocalDateTime.class) {</span>
					DateTimeFormatter formatter;
					String regexp;

<span class="nc bnc" id="L188" title="All 2 branches missed.">					if (variable.size() == 1) {</span>
<span class="nc" id="L189">						formatter = defaultFormatter;</span>
<span class="nc" id="L190">						regexp = defaultFormatterRegexp;</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">					} else if (variable.size() == 2) {</span>
<span class="nc" id="L192">						formatter = DateTimeFormatter.ofPattern(variable.get(1));</span>
<span class="nc" id="L193">						regexp = asRegularExpression(variable.get(1));</span>
					} else {
<span class="nc" id="L195">						throw new IllegalArgumentException();</span>
					}

<span class="nc bnc" id="L198" title="All 2 branches missed.">					postProcessors.put(variable.get(0), p -&gt; p == null ? null : LocalDateTime.parse(p, formatter));</span>
<span class="nc" id="L199">					b.append(&quot;(?&lt;&quot; + variable.get(0) + &quot;&gt;&quot; + regexp + &quot;)&quot;);</span>
<span class="nc" id="L200">				} else {</span>
<span class="nc" id="L201">					throw new IllegalArgumentException();</span>
				}
<span class="nc" id="L203">			}</span>

		});

<span class="nc" id="L207">		Pattern pattern = Pattern.compile(b.toString());</span>

<span class="nc" id="L209">		return new RepositoryPathPattern() {</span>

			@Override
			public RepositoryPathMatcher matcher(Path path) {

<span class="nc" id="L214">				return new RepositoryPathMatcher() {</span>

					java.util.regex.Matcher m;

					@Override
					public boolean matches() {
<span class="nc" id="L220">						m = pattern.matcher(pathJoiner.join(path));</span>
<span class="nc" id="L221">						return m.matches();</span>
					}

					@Override
					public &lt;T&gt; T get(String variable, Class&lt;T&gt; type) {
<span class="nc bnc" id="L226" title="All 2 branches missed.">						if (m == null)</span>
<span class="nc" id="L227">							throw new IllegalStateException();</span>
<span class="nc" id="L228">						return type.cast(postProcessors.get(variable).apply(m.group(variable)));</span>
					}

				};
			}
		};

	}

	private Set&lt;String&gt; getFiles(CommonP2Repository repo) throws IOException {
<span class="nc" id="L238">		Set&lt;String&gt; files = new TreeSet&lt;&gt;();</span>

<span class="nc" id="L240">		files.add(P2RepositoryFactory.P2INDEX);</span>

<span class="nc" id="L242">		repo.accept(new P2RepositoryVisitor&lt;Void&gt;() {</span>

			@Override
			public Void visit(P2CompositeRepository repo) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">				for (DataCompression dc : repo.getArtifactDataCompressions())</span>
<span class="nc" id="L247">					files.add(P2IndexType.compositeArtifacts.getFilePrefix() + &quot;.&quot; + dc.getFileSuffix());</span>

<span class="nc bnc" id="L249" title="All 2 branches missed.">				for (DataCompression dc : repo.getMetadataDataCompressions())</span>
<span class="nc" id="L250">					files.add(P2IndexType.compositeMetadata.getFilePrefix() + &quot;.&quot; + dc.getFileSuffix());</span>

<span class="nc" id="L252">				return null;</span>
			}

			@Override
			public Void visit(P2Repository repo) {
<span class="nc bnc" id="L257" title="All 2 branches missed.">				for (DataCompression dc : repo.getArtifactDataCompressions())</span>
<span class="nc" id="L258">					files.add(P2IndexType.artifacts.getFilePrefix() + &quot;.&quot; + dc.getFileSuffix());</span>

<span class="nc bnc" id="L260" title="All 2 branches missed.">				for (DataCompression dc : repo.getMetadataDataCompressions())</span>
<span class="nc" id="L261">					files.add(P2IndexType.metadata.getFilePrefix() + &quot;.&quot; + dc.getFileSuffix());</span>

				try {
					ArtifactRepositoryFacade facade;
<span class="nc" id="L265">					facade = repo.getArtifactRepositoryFacade();</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">					for (ArtifactId e : facade.getArtifacts().keySet())</span>
<span class="nc" id="L267">						files.add(repo.getPath().relativize(facade.getArtifactUri(e)).toString()</span>
<span class="nc" id="L268">								.replace(File.separatorChar, '/'));</span>
<span class="nc" id="L269">				} catch (IOException e1) {</span>
<span class="nc" id="L270">					throw new RuntimeException(e1);</span>
<span class="nc" id="L271">				}</span>

<span class="nc" id="L273">				return null;</span>
			}
		});

<span class="nc" id="L277">		return files;</span>
	}

	private void doInstall(Path sourcePath, Set&lt;String&gt; sourceFiles, Path targetPath, Set&lt;String&gt; targetFiles)
			throws IOException {

<span class="nc" id="L283">		TreeSet&lt;Path&gt; toRemove = new TreeSet&lt;&gt;();</span>

<span class="nc bnc" id="L285" title="All 2 branches missed.">		for (String p : Sets.union(sourceFiles, targetFiles)) {</span>
<span class="nc" id="L286">			Path p1 = sourcePath.resolve(p);</span>
<span class="nc" id="L287">			Path p2 = targetPath.resolve(p);</span>

<span class="nc" id="L289">			Files.createDirectories(p2.getParent());</span>

<span class="nc bnc" id="L291" title="All 4 branches missed.">			if (sourceFiles.contains(p) &amp;&amp; targetFiles.contains(p)) {</span>
<span class="nc" id="L292">				ByteSource bs1 = new PathByteSource(p1);</span>
<span class="nc" id="L293">				ByteSource bs2 = new PathByteSource(p2);</span>

<span class="nc bnc" id="L295" title="All 2 branches missed.">				if (!bs1.contentEquals(bs2)) {</span>
<span class="nc" id="L296">					Files.copy(p1, p2, StandardCopyOption.COPY_ATTRIBUTES, StandardCopyOption.REPLACE_EXISTING);</span>
				} else {
					// System.out.println(&quot;UNMODIFIED &quot; + p);
				}
<span class="nc bnc" id="L300" title="All 2 branches missed.">			} else if (sourceFiles.contains(p)) {</span>
<span class="nc" id="L301">				Files.copy(p1, p2, StandardCopyOption.COPY_ATTRIBUTES);</span>
			} else {
<span class="nc" id="L303">				Files.delete(p2);</span>
<span class="nc" id="L304">				toRemove.add(p2.getParent());</span>
			}
<span class="nc" id="L306">		}</span>

<span class="nc bnc" id="L308" title="All 2 branches missed.">		for (Path p : toRemove.descendingSet()) {</span>
			try {
<span class="nc" id="L310">				Files.delete(p);</span>
<span class="nc" id="L311">			} catch (DirectoryNotEmptyException e) {</span>
				// that's ok
<span class="nc" id="L313">			}</span>
<span class="nc" id="L314">		}</span>
<span class="nc" id="L315">	}</span>

	public void replace(CommonP2Repository source, CommonP2Repository target) throws IOException {
<span class="nc" id="L318">		Preconditions.checkNotNull(source);</span>
<span class="nc" id="L319">		Preconditions.checkNotNull(target);</span>

<span class="nc" id="L321">		Set&lt;String&gt; f1 = getFiles(source);</span>
<span class="nc" id="L322">		Set&lt;String&gt; f2 = getFiles(target);</span>

<span class="nc" id="L324">		doInstall(source.getPath(), f1, target.getPath(), f2);</span>
<span class="nc" id="L325">	}</span>

	public void install(CommonP2Repository source, Path target) throws IOException {
<span class="nc" id="L328">		Preconditions.checkNotNull(source);</span>
<span class="nc" id="L329">		Preconditions.checkNotNull(target);</span>

<span class="nc" id="L331">		Set&lt;String&gt; f1 = getFiles(source);</span>

<span class="nc" id="L333">		doInstall(source.getPath(), f1, target, Collections.emptySet());</span>

<span class="nc" id="L335">	}</span>

	static String asRegularExpression(String pattern) {
<span class="nc" id="L338">		StringBuilder regex = new StringBuilder();</span>

<span class="nc bnc" id="L340" title="All 2 branches missed.">		for (int i = 0; i != pattern.length();) {</span>
<span class="nc" id="L341">			int start = i;</span>
<span class="nc" id="L342">			char c = pattern.charAt(i++);</span>
<span class="nc bnc" id="L343" title="All 4 branches missed.">			while (i != pattern.length() &amp;&amp; pattern.charAt(i) == c)</span>
<span class="nc" id="L344">				++i;</span>
<span class="nc" id="L345">			String part = pattern.substring(start, i);</span>
<span class="nc bnc" id="L346" title="All 24 branches missed.">			switch (part) {</span>
			case &quot;yyyy&quot;:
			case &quot;yy&quot;:
			case &quot;MM&quot;:
			case &quot;dd&quot;:
			case &quot;HH&quot;:
			case &quot;mm&quot;:
			case &quot;ss&quot;:
<span class="nc" id="L354">				regex.append(&quot;\\d{&quot; + part.length() + &quot;}&quot;);</span>
<span class="nc" id="L355">				break;</span>
			default:
<span class="nc" id="L357">				throw new IllegalArgumentException(&quot;Unhandled part '&quot; + part + &quot;' of pattern '&quot; + pattern + &quot;'&quot;);</span>
			}
<span class="nc" id="L359">		}</span>
<span class="nc" id="L360">		return regex.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>